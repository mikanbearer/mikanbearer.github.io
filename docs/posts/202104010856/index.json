



    
        
    




{
  "result": {
    "content": "\u003cp\u003e應該會是個長篇，先記錄一下\u003c/p\u003e\n\u003cp\u003e環境是CentOS 7\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[root@node1 ~]# cat /etc/*release\nCentOS Linux release 7.7.1908 (Core)\nNAME=\u0026quot;CentOS Linux\u0026quot;\nVERSION=\u0026quot;7 (Core)\u0026quot;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(1).offsetTop, behavior: 'smooth'})\"\u003e安裝Zeek\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(2).offsetTop, behavior: 'smooth'})\"\u003e準備ELK Stack\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(3).offsetTop, behavior: 'smooth'})\"\u003e安裝Filebeat\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(4).offsetTop, behavior: 'smooth'})\"\u003e設定Logstash\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003ch2 id=1\u003e安裝Zeek\u003c/h2\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e參考官方\u003ca href=\"https://docs.zeek.org/en/current/get-started.html\" target=\"_blank\"\u003eZeek quick start\u003c/a\u003e，接著從安裝開始，環境是CentOS 7，所以用7的repo，這樣比從source安裝來得輕鬆容易\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[root@node1 ~]# cd /etc/yum.repos.d/\n[root@node1 ~]# wget https://download.opensuse.org/repositories/security:zeek/CentOS_7/security:zeek.repo\n[root@node1 ~]# yum -y install zeek\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e加入PATH以利操作\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[root@node1 ~]# export PATH=/opt/zeek/bin:$PATH\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接著進入操作目錄，結構大概是這樣，需要使用的binary file都在./bin，而./logs將會是之後輸出的東西\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[root@node1 ~]# cd /opt/zeek\n[root@node1 ~]# tree -d\n.\n├── bin\n│   └── broctl -\u0026gt; /opt/zeek/lib/zeek/python/zeekctl\n├── etc\n│   └── zkg\n├── include\n│   ├── binpac\n│   ├── broker\n│   │   ├── alm\n│   │   ├── detail\n│   │   └── mixin\n...\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接下來更改etc/node.cfg，將interface改為實際的interface\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:etc/node.cfg\" data-lang=\":etc/node.cfg\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Example ZeekControl node configuration.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# This example has a standalone node ready to go except for possibly changing\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# the sniffing interface.\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# This is a complete standalone configuration.  Most likely you will\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# only need to change the interface.\u003c/span\u003e\n\u003cspan style=\"color:#66d9ef\"\u003e[zeek]\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003etype\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003estandalone\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehost\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003elocalhost\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003einterface\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003eens33\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e像目前個人環境是ens33\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[root@node1 zeek]# ip link show\n1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n2: ens33: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000\n    link/ether 00:0c:29:29:c1:3d brd ff:ff:ff:ff:ff:ff\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接著install→start就開始運作了\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[root@node1 zeek]# zeekctl \nWarning: zeekctl node config has changed (run the zeekctl \u0026quot;deploy\u0026quot; command)\n\nWelcome to ZeekControl 2.3.0\n\nType \u0026quot;help\u0026quot; for help.\n\n[ZeekControl] \u0026gt; install\nremoving old policies in /opt/zeek/spool/installed-scripts-do-not-touch/site ...\nremoving old policies in /opt/zeek/spool/installed-scripts-do-not-touch/auto ...\ncreating policy directories ...\ninstalling site policies ...\ngenerating standalone-layout.zeek ...\ngenerating local-networks.zeek ...\ngenerating zeekctl-config.zeek ...\ngenerating zeekctl-config.sh ...\n[ZeekControl] \u0026gt; start\nstarting zeek ...\ncreating crash report for previously crashed nodes: zeek\n[ZeekControl] \u0026gt; \n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接下來進行測試，像我在local用\u003ccode\u003ecurl www.gogole.com\u003c/code\u003e來試著產生流量，就會輸出log\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-:/opt/zeek/logs/current/conn.log\" data-lang=\":/opt/zeek/logs/current/conn.log\"\u003e#separator \\x09\n#set_separator  ,\n#empty_field    (empty)\n#unset_field    -\n#path   conn\n#open   2021-04-01-17-00-10\n#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       proto   service        duration        orig_bytes      resp_bytes      conn_state      local_orig      local_resp    missed_bytes     history orig_pkts       orig_ip_bytes   resp_pkts       resp_ip_bytes   tunnel_parents\n#types  time    string  addr    port    addr    port    enum    string  interval        count   count string   bool    bool    count   string  count   count   count   count   set[string]\n1617267600.372464       CHSiZd4C1O4cshYqNe      192.168.149.131 49304   8.8.8.8 53      udp     dns   0.007085 0       46      SHR     T       F       0       Cd      0       0       1       74      -\n1617267600.387133       CyUiG03tFWAlDH9oLh      192.168.149.131 34398   8.8.8.8 53      udp     dns   0.004931 0       62      SHR     T       F       0       Cd      0       0       1       90      -\n1617267600.406175       CdlOnF2L8iphj6bKuc      192.168.149.131 50972   8.8.8.8 53      udp     dns   0.004991 0       44      SHR     T       F       0       Cd      0       0       1       72      -\n1617267600.418985       Cp20ej3GjcOji8Z91a      192.168.149.131 44319   8.8.8.8 53      udp     dns   0.004332 0       103     SHR     T       F       0       Cd      0       0       1       131     -\n1617267600.429460       CtTxvF14IJDFfhdUv1      192.168.149.131 38851   8.8.8.8 53      udp     dns   0.006173 0       84      SHR     T       F       0       Cd      0       0       1       112     -\n1617267073.050473       ChR0fl3uIxHQhxbx7i      192.168.149.1   3467    192.168.149.131 22      tcp   -        249.904010      2880    0       OTH     T       T       0       \n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e特定protocol的也有\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-:logs/current/http.log\" data-lang=\":logs/current/http.log\"\u003e#separator \\x09\n#set_separator  ,\n#empty_field    (empty)\n#unset_field    -\n#path   http\n#open   2021-04-01-11-01-23\n#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       trans_depth     method  host    uri     referrer        version user_agent      origin  request_body_len        response_body_len      status_code      status_msg      info_code       info_msg        tags    username        password        proxied orig_fuids      orig_filenames  orig_mime_types resp_fuids      resp_filenames  resp_mime_types\n#types  time    string  addr    port    addr    port    count   string  string  string  string  string  string  string  count   count   count   string  count   string  set[enum]       string  string  set[string]     vector[string]  vector[string]  vector[string]  vector[string]  vector[string]  vector[string]\n1617246083.475994       CVQf6b1T0kF62QfLGb      192.168.149.131 58566   172.217.160.100 80      1       -       -       -       -       1.1     -       -       0       370     302     Found   -       -       (empty) -      -        -       -       -       -       F10mzw4W7rnzD1ZIF2      -       text/html\n1617246110.589529       CszGkz1WuedRAcY4cb      192.168.149.131 58568   172.217.160.100 80      1       -       -       -       -       1.1     -       -       0       370     302     Found   -       -       (empty) -      -        -       -       -       -       FXO4sMNQ5bca6pMWd       -       text/html\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-:logs/current/dns.log\" data-lang=\":logs/current/dns.log\"\u003e#separator \\x09\n#set_separator  ,\n#empty_field    (empty)\n#unset_field    -\n#path   dns\n#open   2021-04-01-11-00-11\n#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       proto   trans_id        rtt     query   qclass  qclass_name     qtype   qtype_name      rcode   rcode_name      AA      TC      RD     RA       Z       answers TTLs    rejected\n#types  time    string  addr    port    addr    port    enum    count   interval        string  count   string  count   string  count   string  bool    bool    bool    bool    count   vector[string]  vector[interval]       bool\n1617246000.367800       CYZscL1WZgToo0aFF2      192.168.149.131 56696   8.8.8.8 53      udp     49314   -       -       -       -       -       -       3       NXDOMAIN        F       F       F       F       0       -      -        T\n1617246000.379853       C9R48F26JuUAtrJJLe      192.168.149.131 36461   8.8.8.8 53      udp     48755   -       -       -       -       -       -       3       NXDOMAIN        F       F       F       F       0       -      -        F\n1617246000.390934       Cp9FG4EHDInTZ6HXi       192.168.149.131 50133   8.8.8.8 53      udp     47126   -       -       -       -       -       -       3       NXDOMAIN        F       F       F       F       0       -      -        T\n1617246000.403496       Cdx4KT2Elnhilucw9i      192.168.149.131 53514   8.8.8.8 53      udp     4357    -       8.8.8.8.in-addr.arpa    -       -       -       -       0       NOERROR F       F       F       T       0      dns.google       21259.000000    F\n1617246000.416114       CSxB3p2gsvyQqYYltj      192.168.149.131 44751   8.8.8.8 53      udp     43509   -       36.200.58.216.in-addr.arpa      -       -       -       -       0       NOERROR F       F       F       T      0        tsa01s08-in-f4.1e100.net,tsa01s08-in-f36.1e100.net      20406.000000,20406.000000       F\n1617246000.427219       CrEBdC1JfzdCrhaRT9      192.168.149.131 37798   8.8.8.8 53      udp     24914   -       -       -       -       -       -       3       NXDOMAIN        F       F       F       F       0       -      -        T\n1617246083.436974       CigcJd2IFtMv5YXQi2      192.168.149.131 50755   8.8.8.8 53      udp     19516   -       www.google.com  -       -       -       -       0       NOERROR F       F       F       T       0       2404:6800:4012:1::2004  180.000000      F\n1617246083.436940       CigcJd2IFtMv5YXQi2      192.168.149.131 50755   8.8.8.8 53      udp     47407   -       www.google.com  -       -       -       -       0       NOERROR F       F       F       T       0       172.217.160.100 211.000000      F\n1617246110.557257       CqJ2n8WPwuhPaVVNl       192.168.149.131 37226   8.8.8.8 53      udp     7595    -       www.google.com  -       -       -       -       0       NOERROR F       F       F       T       0       2404:6800:4012:1::2004  153.000000      F\n1617246110.557297       CqJ2n8WPwuhPaVVNl       192.168.149.131 37226   8.8.8.8 53      udp     16544   -       www.google.com  -       -       -       -       0       NOERROR F       F       F       T       0       172.217.160.100 184.000000      F\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003ch2 id=2\u003e準備ELK Stack\u003c/h2\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n使用\u003ca href=\"https://github.com/deviantony/docker-elk\" target=\"_blank\"\u003edocker-elk\u003c/a\u003e節省時間，一樣使用compose環境\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003egit clone https://github.com/deviantony/docker-elk\ncd docker-elk\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e稍後只先使用logstash，所以先把下面comment掉\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e21\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e22\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e23\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e24\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e25\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e26\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e27\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e28\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e29\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e30\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e31\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e32\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e33\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e34\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e35\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e36\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e37\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e38\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e39\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e40\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e41\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e42\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e43\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e44\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e45\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e46\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e47\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e48\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e49\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:docker-compose.yml\" data-lang=\":docker-compose.yml\"\u003e...\n\n  \u003cspan style=\"color:#f92672\"\u003elogstash\u003c/span\u003e:\n    \u003cspan style=\"color:#f92672\"\u003ebuild\u003c/span\u003e:\n      \u003cspan style=\"color:#f92672\"\u003econtext\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003elogstash/\u003c/span\u003e\n      \u003cspan style=\"color:#f92672\"\u003eargs\u003c/span\u003e:\n        \u003cspan style=\"color:#f92672\"\u003eELK_VERSION\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e$ELK_VERSION\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003evolumes\u003c/span\u003e:\n      - \u003cspan style=\"color:#f92672\"\u003etype\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ebind\u003c/span\u003e\n        \u003cspan style=\"color:#f92672\"\u003esource\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e./logstash/config/logstash.yml\u003c/span\u003e\n        \u003cspan style=\"color:#f92672\"\u003etarget\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e/usr/share/logstash/config/logstash.yml\u003c/span\u003e\n        \u003cspan style=\"color:#f92672\"\u003eread_only\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n      - \u003cspan style=\"color:#f92672\"\u003etype\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ebind\u003c/span\u003e\n        \u003cspan style=\"color:#f92672\"\u003esource\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e./logstash/pipeline\u003c/span\u003e\n        \u003cspan style=\"color:#f92672\"\u003etarget\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e/usr/share/logstash/pipeline\u003c/span\u003e\n        \u003cspan style=\"color:#f92672\"\u003eread_only\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003eports\u003c/span\u003e:\n      - \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;5044:5044\u0026#34;\u003c/span\u003e\n      - \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;5000:5000/tcp\u0026#34;\u003c/span\u003e\n      - \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;5000:5000/udp\u0026#34;\u003c/span\u003e\n      - \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;9600:9600\u0026#34;\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003eenvironment\u003c/span\u003e:\n      \u003cspan style=\"color:#f92672\"\u003eLS_JAVA_OPTS\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-Xmx256m -Xms256m\u0026#34;\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003enetworks\u003c/span\u003e:\n      - \u003cspan style=\"color:#ae81ff\"\u003eelk\u003c/span\u003e\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e    \u003cspan style=\"color:#75715e\"\u003e#depends_on:\u003c/span\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e    \u003cspan style=\"color:#75715e\"\u003e#  - elasticsearch\u003c/span\u003e\n\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e雖然docker logstash預設是\u003ccode\u003e/usr/share/logstash/pipeline\u003c/code\u003e底下全吃，但還是用原本的pipline就好，順便加上一個stdout測試\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-:logstash/pipline/logstash.conf\" data-lang=\":logstash/pipline/logstash.conf\"\u003einput {\n        beats {\n                port =\u0026gt; 5044\n        }\n\n        tcp {\n                port =\u0026gt; 5000\n        }\n}\n\n## Add your filters / logstash plugins configuration here\n\noutput {\n\n        stdout {}\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e啟動測試\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003edocker-compose up logstash\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e試著用netcat打一個tcp的hellow world\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eecho -n \u0026quot;Hellow World\u0026quot; | nc localhost 5000\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e另一邊應該要能看到才對\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e...\nlogstash_1       | {\nlogstash_1       |     \u0026quot;@timestamp\u0026quot; =\u0026gt; 2021-04-01T06:37:59.135Z,\nlogstash_1       |       \u0026quot;@version\u0026quot; =\u0026gt; \u0026quot;1\u0026quot;,\nlogstash_1       |        \u0026quot;message\u0026quot; =\u0026gt; \u0026quot;Hellow World\u0026quot;,\nlogstash_1       |           \u0026quot;host\u0026quot; =\u0026gt; \u0026quot;gateway\u0026quot;,\nlogstash_1       |           \u0026quot;port\u0026quot; =\u0026gt; 41502\nlogstash_1       | }\n\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003ch2 id=3\u003e安裝Filebeat\u003c/h2\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接下來安裝filebeat\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ecurl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.12.0-x86_64.rpm\nrpm -vi filebeat-7.12.0-x86_64.rpm\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e更改設定檔，預設的可以先備份起來，這次就先抓conn.log\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:/etc/filebeat/filebeat.yml\" data-lang=\":/etc/filebeat/filebeat.yml\"\u003e\u003cspan style=\"color:#f92672\"\u003efilebeat.inputs\u003c/span\u003e:\n- \u003cspan style=\"color:#f92672\"\u003einput_type\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003elog\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003epaths\u003c/span\u003e:\n    - \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/opt/zeek/logs/current/conn.log\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003efields\u003c/span\u003e:\n    \u003cspan style=\"color:#f92672\"\u003etype\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;zeek\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003efields_under_root\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n\n\u003cspan style=\"color:#f92672\"\u003eoutput.logstash\u003c/span\u003e:\n  \u003cspan style=\"color:#f92672\"\u003ehosts\u003c/span\u003e: [\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;localhost:5044\u0026#34;\u003c/span\u003e]                                                                                                            \u003cspan style=\"color:#ae81ff\"\u003e~                              \u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接者啟動beat\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003esystemctl start filebeat\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e如果zeek在啟動中，沒意外的話logstash就會有output了\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003elogstash_1       | {\nlogstash_1       |     \u0026quot;@timestamp\u0026quot; =\u0026gt; 2021-04-01T06:57:26.348Z,\nlogstash_1       |       \u0026quot;@version\u0026quot; =\u0026gt; \u0026quot;1\u0026quot;,\nlogstash_1       |        \u0026quot;message\u0026quot; =\u0026gt; \u0026quot;1617260228.248718\\tCdMkYf3rnBHgxql95l\\tfe80::643c:3463:77be:666b\\t52758\\tff02::1:3\\t5355\\tudp\\tdns\\t0.410540\\t44\\t0\\tS0\\tF\\tF\\t0\\tD\\t2\\t140\\t0\\t0\\t-\u0026quot;,\nlogstash_1       |           \u0026quot;type\u0026quot; =\u0026gt; \u0026quot;zeek\u0026quot;,\nlogstash_1       |            \u0026quot;ecs\u0026quot; =\u0026gt; {\nlogstash_1       |         \u0026quot;version\u0026quot; =\u0026gt; \u0026quot;1.8.0\u0026quot;\nlogstash_1       |     },\nlogstash_1       |            \u0026quot;log\u0026quot; =\u0026gt; {\nlogstash_1       |           \u0026quot;file\u0026quot; =\u0026gt; {\nlogstash_1       |             \u0026quot;path\u0026quot; =\u0026gt; \u0026quot;/opt/zeek/logs/current/conn.log\u0026quot;\nlogstash_1       |         },\nlogstash_1       |         \u0026quot;offset\u0026quot; =\u0026gt; 3768\nlogstash_1       |     },\nlogstash_1       |           \u0026quot;host\u0026quot; =\u0026gt; {\nlogstash_1       |         \u0026quot;name\u0026quot; =\u0026gt; \u0026quot;node1\u0026quot;\nlogstash_1       |     },\nlogstash_1       |          \u0026quot;agent\u0026quot; =\u0026gt; {\nlogstash_1       |                   \u0026quot;id\u0026quot; =\u0026gt; \u0026quot;f611ea10-5301-4db6-8dc5-be414a277b4e\u0026quot;,\nlogstash_1       |                 \u0026quot;name\u0026quot; =\u0026gt; \u0026quot;node1\u0026quot;,\nlogstash_1       |              \u0026quot;version\u0026quot; =\u0026gt; \u0026quot;7.12.0\u0026quot;,\nlogstash_1       |             \u0026quot;hostname\u0026quot; =\u0026gt; \u0026quot;node1\u0026quot;,\nlogstash_1       |                 \u0026quot;type\u0026quot; =\u0026gt; \u0026quot;filebeat\u0026quot;,\nlogstash_1       |         \u0026quot;ephemeral_id\u0026quot; =\u0026gt; \u0026quot;9d6d56cf-889b-4032-8d28-64438746162a\u0026quot;\nlogstash_1       |     },\nlogstash_1       |           \u0026quot;tags\u0026quot; =\u0026gt; [\nlogstash_1       |         [0] \u0026quot;beats_input_codec_plain_applied\u0026quot;\nlogstash_1       |     ]\nlogstash_1       | }\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003ch2 id=4\u003e設定Logstash\u003c/h2\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接著設定logstash，首先從conn.log中看field，以此定義logstash的column\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[root@node1 zeek]# cat logs/current/conn.log \n#separator \\x09\n#set_separator  ,\n#empty_field    (empty)\n#unset_field    -\n#path   conn\n#open   2021-04-01-15-00-19\n#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       proto   service duration        orig_bytes      resp_bytes      conn_state      local_orig \nsed_bytes       history orig_pkts       orig_ip_bytes   resp_pkts       resp_ip_bytes   tunnel_parents\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003efilter大概這樣，csv分隔為一個tab(\\t)，把原始的message移掉\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003einput {\n        beats {\n                port =\u0026gt; 5044\n        }\n\n        tcp {\n                port =\u0026gt; 5000\n        }\n}\n\n## Add your filters / logstash plugins configuration here\nfilter {\n        if [message] =~ /^#/ {\n                drop { }\n        }\n\n        if [type] == \u0026quot;zeek\u0026quot; {\n\n                csv {\n                        columns =\u0026gt; [\u0026quot;ts\u0026quot;,\u0026quot;uid\u0026quot;,\u0026quot;id_orig_h\u0026quot;,\u0026quot;id_orig_p\u0026quot;,\u0026quot;id_resp_h\u0026quot;,\u0026quot;id_resp_p\u0026quot;,\u0026quot;proto\u0026quot;,\u0026quot;service\u0026quot;,\u0026quot;duration\u0026quot;,\u0026quot;orig_bytes\u0026quot;,\u0026quot;resp_bytes\u0026quot;,\u0026quot;conn_state\u0026quot;,\u0026quot;local_orig\u0026quot;,\u0026quot;local_resp\u0026quot;,\u0026quot;missed_bytes\u0026quot;,\u0026quot;history\u0026quot;,\u0026quot;orig_pkts\u0026quot;,\u0026quot;orig_ip_bytes\u0026quot;,\u0026quot;resp_pkts\u0026quot;,\u0026quot;resp_ip_bytes\u0026quot;,\u0026quot;tunnel_parents\u0026quot;]\n                        separator =\u0026gt; \u0026quot;  \u0026quot;\n                }\n\n                date {\n                        match =\u0026gt; [ \u0026quot;ts\u0026quot;, \u0026quot;UNIX\u0026quot; ]\n                }\n\n                geoip {\n                        source =\u0026gt; \u0026quot;id.orig_h\u0026quot;\n                }\n\n                mutate {\n                        convert =\u0026gt; { \u0026quot;id.orig_p\u0026quot; =\u0026gt; \u0026quot;integer\u0026quot; }\n                        convert =\u0026gt; { \u0026quot;id.resp_p\u0026quot; =\u0026gt; \u0026quot;integer\u0026quot; }\n                        convert =\u0026gt; { \u0026quot;orig_bytes\u0026quot; =\u0026gt; \u0026quot;integer\u0026quot; }\n                        convert =\u0026gt; { \u0026quot;duration\u0026quot; =\u0026gt; \u0026quot;float\u0026quot; }\n                        convert =\u0026gt; { \u0026quot;resp_bytes\u0026quot; =\u0026gt; \u0026quot;integer\u0026quot; }\n                        convert =\u0026gt; { \u0026quot;missed_bytes\u0026quot; =\u0026gt; \u0026quot;integer\u0026quot; }\n                        convert =\u0026gt; { \u0026quot;orig_pkts\u0026quot; =\u0026gt; \u0026quot;integer\u0026quot; }\n                        convert =\u0026gt; { \u0026quot;orig_ip_bytes\u0026quot; =\u0026gt; \u0026quot;integer\u0026quot; }\n                        convert =\u0026gt; { \u0026quot;resp_pkts\u0026quot; =\u0026gt; \u0026quot;integer\u0026quot; }\n                        convert =\u0026gt; { \u0026quot;resp_ip_bytes\u0026quot; =\u0026gt; \u0026quot;integer\u0026quot; }\n                        remove_field =\u0026gt; [\u0026quot;message\u0026quot;,\u0026quot;host\u0026quot;,\u0026quot;path\u0026quot;,\u0026quot;@version\u0026quot;,\u0026quot;@timestamp\u0026quot;]\n                }\n        }\n}\n\n\noutput {\n\n        stdout {}\n\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e就能看到乾乾淨淨的stdout\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003elogstash_1       | {\nlogstash_1       |                 \u0026quot;ts\u0026quot; =\u0026gt; \u0026quot;1617267496.641087\u0026quot;,\nlogstash_1       |               \u0026quot;type\u0026quot; =\u0026gt; \u0026quot;zeek\u0026quot;,\nlogstash_1       |                \u0026quot;ecs\u0026quot; =\u0026gt; {\nlogstash_1       |         \u0026quot;version\u0026quot; =\u0026gt; \u0026quot;1.8.0\u0026quot;\nlogstash_1       |     },\nlogstash_1       |          \u0026quot;resp_pkts\u0026quot; =\u0026gt; 1,\nlogstash_1       |      \u0026quot;orig_ip_bytes\u0026quot; =\u0026gt; 0,\nlogstash_1       |           \u0026quot;duration\u0026quot; =\u0026gt; 0.006385,\nlogstash_1       |       \u0026quot;missed_bytes\u0026quot; =\u0026gt; 0,\nlogstash_1       |     \u0026quot;tunnel_parents\u0026quot; =\u0026gt; \u0026quot;-\u0026quot;,\nlogstash_1       |          \u0026quot;id_orig_h\u0026quot; =\u0026gt; \u0026quot;192.168.149.131\u0026quot;,\nlogstash_1       |          \u0026quot;id_orig_p\u0026quot; =\u0026gt; \u0026quot;43447\u0026quot;,\nlogstash_1       |            \u0026quot;history\u0026quot; =\u0026gt; \u0026quot;Cd\u0026quot;,\nlogstash_1       |         \u0026quot;local_orig\u0026quot; =\u0026gt; \u0026quot;T\u0026quot;,\nlogstash_1       |      \u0026quot;resp_ip_bytes\u0026quot; =\u0026gt; 134,\nlogstash_1       |         \u0026quot;local_resp\u0026quot; =\u0026gt; \u0026quot;F\u0026quot;,\nlogstash_1       |              \u0026quot;proto\u0026quot; =\u0026gt; \u0026quot;udp\u0026quot;,\nlogstash_1       |                \u0026quot;uid\u0026quot; =\u0026gt; \u0026quot;Csgf6u10JB1jOiyhp2\u0026quot;,\nlogstash_1       |          \u0026quot;id_resp_h\u0026quot; =\u0026gt; \u0026quot;8.8.8.8\u0026quot;,\nlogstash_1       |         \u0026quot;conn_state\u0026quot; =\u0026gt; \u0026quot;SHR\u0026quot;,\nlogstash_1       |            \u0026quot;service\u0026quot; =\u0026gt; \u0026quot;dns\u0026quot;,\nlogstash_1       |                \u0026quot;log\u0026quot; =\u0026gt; {\nlogstash_1       |         \u0026quot;offset\u0026quot; =\u0026gt; 2497,\nlogstash_1       |           \u0026quot;file\u0026quot; =\u0026gt; {\nlogstash_1       |             \u0026quot;path\u0026quot; =\u0026gt; \u0026quot;/opt/zeek/logs/current/conn.log\u0026quot;\nlogstash_1       |         }\nlogstash_1       |     },\nlogstash_1       |              \u0026quot;agent\u0026quot; =\u0026gt; {\nlogstash_1       |             \u0026quot;hostname\u0026quot; =\u0026gt; \u0026quot;node1\u0026quot;,\nlogstash_1       |              \u0026quot;version\u0026quot; =\u0026gt; \u0026quot;7.12.0\u0026quot;,\nlogstash_1       |                   \u0026quot;id\u0026quot; =\u0026gt; \u0026quot;f611ea10-5301-4db6-8dc5-be414a277b4e\u0026quot;,\nlogstash_1       |                 \u0026quot;name\u0026quot; =\u0026gt; \u0026quot;node1\u0026quot;,\nlogstash_1       |                 \u0026quot;type\u0026quot; =\u0026gt; \u0026quot;filebeat\u0026quot;,\nlogstash_1       |         \u0026quot;ephemeral_id\u0026quot; =\u0026gt; \u0026quot;40d08d5b-e461-469c-b39a-7241ae7e1073\u0026quot;\nlogstash_1       |     },\nlogstash_1       |         \u0026quot;orig_bytes\u0026quot; =\u0026gt; 0,\nlogstash_1       |          \u0026quot;id_resp_p\u0026quot; =\u0026gt; \u0026quot;53\u0026quot;,\nlogstash_1       |         \u0026quot;resp_bytes\u0026quot; =\u0026gt; 106,\nlogstash_1       |          \u0026quot;orig_pkts\u0026quot; =\u0026gt; 0,\nlogstash_1       |               \u0026quot;tags\u0026quot; =\u0026gt; [\nlogstash_1       |         [0] \u0026quot;beats_input_codec_plain_applied\u0026quot;,\nlogstash_1       |         [1] \u0026quot;_geoip_lookup_failure\u0026quot;\nlogstash_1       |     ]\nlogstash_1       | }\n\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e",
    "kind": "page",
    "params": {
      "categories": [
        "Security"
      ],
      "date": "2021-04-01T08:56:36+08:00",
      "draft": false,
      "iscjklanguage": true,
      "lastmod": "2021-04-01T08:56:36+08:00",
      "publishdate": "2021-04-01T08:56:36+08:00",
      "tags": [
        "Zeek",
        "Logstash"
      ],
      "title": "整合Zeek與ELK分析流量"
    },
    "permalink": "https://mikanbearer.github.io/posts/202104010856/index.json",
    "type": "posts",
    "wordcount": 2295
  }
}