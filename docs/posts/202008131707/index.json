



    
        
    




{
  "result": {
    "content": "\u003cp\u003ePrometheus是最近非常流行的Pull-based monitoring，主要的角色是以下兩者：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePrometheus：監控方，定期收集資料並存在資料庫\u003c/li\u003e\n\u003cli\u003eExporter：被監控方，回傳監控方需要的資料\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e為了往後學習方便，先來實作一遍這個方便利用的工具\u003c/p\u003e\n\u003cp\u003ePrometheus的基礎運用架構很單純，大在就像下圖：\n\u003cimg src=\"0.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e從圖中可見，Prometheus收集時間序列資料(metrics)都是由自己主動向Exporter發起的，這次大概會做這些：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(1).offsetTop, behavior: 'smooth'})\"\u003e啟動Prometheus\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(2).offsetTop, behavior: 'smooth'})\"\u003e啟動Exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(3).offsetTop, behavior: 'smooth'})\"\u003e使用static config監控\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(4).offsetTop, behavior: 'smooth'})\"\u003e使用file-based service discovery取得target\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ch3 id=1\u003e啟動Prometheus\u003c/h3\u003e\r\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n部屬Prometheus非常簡單，就只是binary配上一個設定檔，指令如下：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ wget https://github.com/prometheus/prometheus/releases/download/v2.20.1/prometheus-2.20.1.linux-amd64.tar.gz\r\n$ tar zxvf prometheus-2.20.1.linux-amd64.tar.gz\r\n$ cd prometheus-2.20.1.linux-amd64\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 1\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 2\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 3\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 4\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 5\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 6\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 7\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 8\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 9\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e10\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e11\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e12\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e13\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e14\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e15\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e16\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e17\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e18\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e19\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e20\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e21\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e22\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e23\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e24\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e25\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e26\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e27\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e28\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e29\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:prometheus.yml\" data-lang=\":prometheus.yml\"\u003e\u003cspan style=\"color:#75715e\"\u003e# my global config\u003c/span\u003e\n\u003cspan style=\"color:#f92672\"\u003eglobal\u003c/span\u003e:\n  \u003cspan style=\"color:#f92672\"\u003escrape_interval\u003c/span\u003e:     \u003cspan style=\"color:#ae81ff\"\u003e15s\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e# Set the scrape interval to every 15 seconds. Default is every 1 minute.\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003eevaluation_interval\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e15s\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e# Evaluate rules every 15 seconds. The default is every 1 minute.\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# scrape_timeout is set to the global default (10s).\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Alertmanager configuration\u003c/span\u003e\n\u003cspan style=\"color:#f92672\"\u003ealerting\u003c/span\u003e:\n  \u003cspan style=\"color:#f92672\"\u003ealertmanagers\u003c/span\u003e:\n  - \u003cspan style=\"color:#f92672\"\u003estatic_configs\u003c/span\u003e:\n    - \u003cspan style=\"color:#f92672\"\u003etargets\u003c/span\u003e:\n      \u003cspan style=\"color:#75715e\"\u003e# - alertmanager:9093\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Load rules once and periodically evaluate them according to the global \u0026#39;evaluation_interval\u0026#39;.\u003c/span\u003e\n\u003cspan style=\"color:#f92672\"\u003erule_files\u003c/span\u003e:\n  \u003cspan style=\"color:#75715e\"\u003e# - \u0026#34;first_rules.yml\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# - \u0026#34;second_rules.yml\u0026#34;\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# A scrape configuration containing exactly one endpoint to scrape:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Here it\u0026#39;s Prometheus itself.\u003c/span\u003e\n\u003cspan style=\"color:#f92672\"\u003escrape_configs\u003c/span\u003e:\n  \u003cspan style=\"color:#75715e\"\u003e# The job name is added as a label `job=\u0026lt;job_name\u0026gt;` to any timeseries scraped from this config.\u003c/span\u003e\n  - \u003cspan style=\"color:#f92672\"\u003ejob_name\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;prometheus\u0026#39;\u003c/span\u003e\n\n    \u003cspan style=\"color:#75715e\"\u003e# metrics_path defaults to \u0026#39;/metrics\u0026#39;\u003c/span\u003e\n    \u003cspan style=\"color:#75715e\"\u003e# scheme defaults to \u0026#39;http\u0026#39;.\u003c/span\u003e\n\n    \u003cspan style=\"color:#f92672\"\u003estatic_configs\u003c/span\u003e:\n    - \u003cspan style=\"color:#f92672\"\u003etargets\u003c/span\u003e: [\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;localhost:9090\u0026#39;\u003c/span\u003e]\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ ./prometheus --config.file=prometheus.yml\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n使用cURL測試一下metrics\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ curl localhost:9090/metrics\r\n# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.\r\n# TYPE go_gc_duration_seconds summary\r\ngo_gc_duration_seconds{quantile=\u0026quot;0\u0026quot;} 8.412e-06\r\ngo_gc_duration_seconds{quantile=\u0026quot;0.25\u0026quot;} 6.8151e-05\r\ngo_gc_duration_seconds{quantile=\u0026quot;0.5\u0026quot;} 0.000435588\r\ngo_gc_duration_seconds{quantile=\u0026quot;0.75\u0026quot;} 0.000661594\r\ngo_gc_duration_seconds{quantile=\u0026quot;1\u0026quot;} 0.001019489\r\ngo_gc_duration_seconds_sum 0.002193234\r\ngo_gc_duration_seconds_count 5\r\n# HELP go_goroutines Number of goroutines that currently exist.\r\n# TYPE go_goroutines gauge\r\n...\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cstrong\u003e就算加上下載，整個過程也不到五分鐘…\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e拿到metrics就是這麼快速，也能進web看看graph，在瀏覽器打上http://prometheus_ip:9090/graph就能看到了，\ntab選擇graph也能看到些簡單的圖表\n\u003cimg src=\"1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ch3 id=\"2\"\u003e啟動Exporter\u003c/h3\u003e\r\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n既然Prometheus已經起來了，那麼來試著監控些什麼，就下載個node exporter來測試\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ewget https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gz\r\ntar zxvf node_exporter-1.0.1.linux-amd64.tar.gz\r\ncd node_exporter-1.0.1.linux-amd64\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n裡面一樣是個binary file，執行下去\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e ./node_exporter --web.listen-address 127.0.0.1:8080\r\ncurl 127.0.0.1:8080/metrics\r\n# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.\r\n# TYPE go_gc_duration_seconds summary\r\ngo_gc_duration_seconds{quantile=\u0026quot;0\u0026quot;} 0\r\ngo_gc_duration_seconds{quantile=\u0026quot;0.25\u0026quot;} 0\r\ngo_gc_duration_seconds{quantile=\u0026quot;0.5\u0026quot;} 0\r\ngo_gc_duration_seconds{quantile=\u0026quot;0.75\u0026quot;} 0\r\ngo_gc_duration_seconds{quantile=\u0026quot;1\u0026quot;} 0\r\ngo_gc_duration_seconds_sum 0\r\ngo_gc_duration_seconds_count 0\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\ncURL測試metrics\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ curl localhost:8080/metrics\r\n# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.\r\n# TYPE go_gc_duration_seconds summary\r\ngo_gc_duration_seconds{quantile=\u0026quot;0\u0026quot;} 9.31e-06\r\ngo_gc_duration_seconds{quantile=\u0026quot;0.25\u0026quot;} 5.488e-05\r\ngo_gc_duration_seconds{quantile=\u0026quot;0.5\u0026quot;} 0.000112915\r\ngo_gc_duration_seconds{quantile=\u0026quot;0.75\u0026quot;} 0.000194093\r\ngo_gc_duration_seconds{quantile=\u0026quot;1\u0026quot;} 0.004481425\r\ngo_gc_duration_seconds_sum 0.175059981\r\ngo_gc_duration_seconds_count 957\r\n# HELP go_goroutines Number of goroutines that currently exist.\r\n# TYPE go_goroutines gauge\r\ngo_goroutines 8\r\n# HELP go_info Information about the Go environment.\r\n# TYPE go_info gauge\r\n...\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e一樣簡單快速\u003c/p\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ch3 id=\"3\"\u003e使用static config進行監控\u003c/h3\u003e\r\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n既然exporter沒問題，那麼是時候建立一個job來get metrics了，就依照\u003ca href=\"https://prometheus.io/docs/prometheus/latest/getting_started/\"\u003e這裡的範例\u003c/a\u003e，一步步操作吧\u003c/p\u003e\n\u003cp\u003e依照範例，建立prometheus.rules.yml，用於依照需求控制紀錄的方式，能降低監控造成的負擔，此範例是記錄下五分鐘平均的cpu狀態\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e1\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e2\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e3\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e4\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:prometheus.rules.yml\" data-lang=\":prometheus.rules.yml\"\u003e\u003cspan style=\"color:#f92672\"\u003egroups\u003c/span\u003e:\n- \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ecpu-node\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003erules\u003c/span\u003e:\n  - \u003cspan style=\"color:#f92672\"\u003erecord\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ejob_instance_mode:node_cpu_seconds:avg_rate5m\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003eexpr\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eavg by (job, instance, mode) (rate(node_cpu_seconds_total[5m]))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n然後修改prometheus.yml，除了增加rule，也新增job，並\u003ca href=\"\"\u003e之前\u003c/a\u003e啟動的exporter\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 1\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 2\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 3\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 4\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 5\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 6\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 7\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 8\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 9\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e10\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e11\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e12\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e13\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e14\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e15\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e16\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e17\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e18\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e19\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e20\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e21\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e22\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e23\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e24\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e25\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e26\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e27\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e28\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e29\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e30\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e31\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e32\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e33\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:prometheus.yml\" data-lang=\":prometheus.yml\"\u003e\u003cspan style=\"color:#f92672\"\u003eglobal\u003c/span\u003e:\n  \u003cspan style=\"color:#f92672\"\u003escrape_interval\u003c/span\u003e:     \u003cspan style=\"color:#ae81ff\"\u003e15s\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e# By default, scrape targets every 15 seconds.\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003eevaluation_interval\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e15s\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e# Evaluate rules every 15 seconds.\u003c/span\u003e\n\n  \u003cspan style=\"color:#75715e\"\u003e# Attach these extra labels to all timeseries collected by this Prometheus instance.\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003eexternal_labels\u003c/span\u003e:\n    \u003cspan style=\"color:#f92672\"\u003emonitor\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;codelab-monitor\u0026#39;\u003c/span\u003e\n\n\u003cspan style=\"color:#f92672\"\u003erule_files\u003c/span\u003e:\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e  - \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;prometheus.rules.yml\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\n\u003cspan style=\"color:#f92672\"\u003escrape_configs\u003c/span\u003e:\n  - \u003cspan style=\"color:#f92672\"\u003ejob_name\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;prometheus\u0026#39;\u003c/span\u003e\n\n    \u003cspan style=\"color:#75715e\"\u003e# Override the global default and scrape targets from this job every 5 seconds.\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003escrape_interval\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e5s\u003c/span\u003e\n\n    \u003cspan style=\"color:#f92672\"\u003estatic_configs\u003c/span\u003e:\n      - \u003cspan style=\"color:#f92672\"\u003etargets\u003c/span\u003e: [\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;localhost:9090\u0026#39;\u003c/span\u003e]\n\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e  - \u003cspan style=\"color:#f92672\"\u003ejob_name\u003c/span\u003e:       \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;node\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e    \u003cspan style=\"color:#75715e\"\u003e# Override the global default and scrape targets from this job every 5 seconds.\u003c/span\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e    \u003cspan style=\"color:#f92672\"\u003escrape_interval\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e5s\u003c/span\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e    \u003cspan style=\"color:#f92672\"\u003estatic_configs\u003c/span\u003e:\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e      - \u003cspan style=\"color:#f92672\"\u003etargets\u003c/span\u003e: [\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;localhost:8080\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;localhost:8081\u0026#39;\u003c/span\u003e]\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e        \u003cspan style=\"color:#f92672\"\u003elabels\u003c/span\u003e:\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e          \u003cspan style=\"color:#f92672\"\u003egroup\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;production\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e      - \u003cspan style=\"color:#f92672\"\u003etargets\u003c/span\u003e: [\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;localhost:8082\u0026#39;\u003c/span\u003e]\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e        \u003cspan style=\"color:#f92672\"\u003elabels\u003c/span\u003e:\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e          \u003cspan style=\"color:#f92672\"\u003egroup\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;canary\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n重新啟動prometheus後，就能用去query job instance了\n\u003cimg src=\"2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ch3 id=\"4\"\u003e使用file-based service discovery取得target\u003c/h3\u003e\r\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n在實務上，不可能每增加個exporter就重新啟動一次，這時候file-based service discovery就很重要，\n這種方式和static config不同，只要修改檔案讓prometheus能去讀取就行，不需要reload\u003c/p\u003e\n\u003cp\u003e先在目錄中建立一個空的file_sd.yml，並修改prometheus.yml\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e21\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e22\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e23\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e24\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e25\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e26\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e27\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e28\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:prometheus.yml\" data-lang=\":prometheus.yml\"\u003e  - \u003cspan style=\"color:#f92672\"\u003ejob_name\u003c/span\u003e:       \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;node\u0026#39;\u003c/span\u003e\n\n    \u003cspan style=\"color:#75715e\"\u003e# Override the global default and scrape targets from this job every 5 seconds.\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003escrape_interval\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e5s\u003c/span\u003e\n\n    \u003cspan style=\"color:#f92672\"\u003efile_sd_configs\u003c/span\u003e:\n      - \u003cspan style=\"color:#f92672\"\u003efiles\u003c/span\u003e:\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e        - \u003cspan style=\"color:#ae81ff\"\u003e./file_sd.yml\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e重新啟動prometheus後，就發現targets回到空空如也的狀態了\n\u003cimg src=\"3.png\" alt=\"\"\u003e\n\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接下來就是要用file來增加targets了，把前版的prometheus.yml中的static config放到file_sd.yml\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e1\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e2\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e3\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e4\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e5\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e6\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:file_sd.yml\" data-lang=\":file_sd.yml\"\u003e- \u003cspan style=\"color:#f92672\"\u003etargets\u003c/span\u003e: [\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;localhost:8080\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;localhost:8081\u0026#39;\u003c/span\u003e]\n  \u003cspan style=\"color:#f92672\"\u003elabels\u003c/span\u003e:\n    \u003cspan style=\"color:#f92672\"\u003egroup\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;production\u0026#39;\u003c/span\u003e\n\n- \u003cspan style=\"color:#f92672\"\u003etargets\u003c/span\u003e: [\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;localhost:8082\u0026#39;\u003c/span\u003e]\n  \u003cspan style=\"color:#f92672\"\u003elabels\u003c/span\u003e:\n    \u003cspan style=\"color:#f92672\"\u003egroup\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;canary\u0026#39;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接下來不需要重新啟動prometheus，也能新增targets了\n\u003cimg src=\"4.png\" alt=\"\"\u003e\u003c/p\u003e",
    "kind": "page",
    "params": {
      "categories": [
        "Monitoring"
      ],
      "date": "2020-08-13T17:07:15+08:00",
      "draft": false,
      "iscjklanguage": true,
      "lastmod": "2020-08-13T17:07:15+08:00",
      "publishdate": "2020-08-13T17:07:15+08:00",
      "tags": [
        "Prometheus"
      ],
      "title": "【Prometheus入門練習-基本操作篇1】從零開始學Prometheus"
    },
    "permalink": "https://mikanbearer.github.io/posts/202008131707/index.json",
    "type": "posts",
    "wordcount": 1624
  }
}