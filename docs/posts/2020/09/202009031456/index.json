



    
        
    




{
  "result": {
    "content": "\u003cp\u003e偶然看到這個\u003ca target=\"_blank\" href=\"https://github.com/atosatto/ansible-dockerswarm\"\u003eAnsible Role: Docker\u003c/a\u003e就想嘗試一下，用得順的話就能輕鬆部屬swarm cluster了，所以試著操作一遍\u003c/p\u003e\n\u003cp\u003e本次環境用三台VM，分別是\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eDebian 9.7(Ansible)：192.168.149.130\u003c/li\u003e\n\u003cli\u003eDebian 9.7(Swarm Manager) * 2：192.168.149.131\u003c/li\u003e\n\u003cli\u003eDebian 9.7(Swarm Worker) * 2：192.168.149.133\n\u003cbr\u003e\u003c/br\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e首先使用ansible galaxy下載role\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ ansible-galaxy install atosatto.docker-swarm\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n工作目錄的樹狀圖，不節外生枝，只要一個inventory和playbook就好\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e.\r\n├── hosts\r\n└── playbook.yml\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\nInventory file主要分為[docker_swarm_manager]和[docker_swarm_worker]兩個group，這個role是用group name來區別manager和worker\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan style=\"color:#f92672\"\u003eall\u003c/span\u003e:\n  \u003cspan style=\"color:#f92672\"\u003echildren\u003c/span\u003e:\n    \u003cspan style=\"color:#f92672\"\u003edocker_swarm_manager\u003c/span\u003e:\n      \u003cspan style=\"color:#f92672\"\u003ehosts\u003c/span\u003e:\n        \u003cspan style=\"color:#f92672\"\u003emanager01\u003c/span\u003e:\n          \u003cspan style=\"color:#f92672\"\u003eansible_host\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e192.168.149.131\u003c/span\u003e\n          \u003cspan style=\"color:#f92672\"\u003eswarm_labels\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003edeploy\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003edocker_swarm_worker\u003c/span\u003e:\n      \u003cspan style=\"color:#f92672\"\u003ehosts\u003c/span\u003e:\n        \u003cspan style=\"color:#f92672\"\u003eworker01\u003c/span\u003e:\n          \u003cspan style=\"color:#f92672\"\u003eansible_host\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e192.168.149.133\u003c/span\u003e\n          \u003cspan style=\"color:#f92672\"\u003eswarm_labels\u003c/span\u003e: [\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;foo\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;bar\u0026#39;\u003c/span\u003e]\n  \u003cspan style=\"color:#f92672\"\u003evars\u003c/span\u003e:\n    \u003cspan style=\"color:#f92672\"\u003eansible_user\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eqaz\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003eansible_password\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e123\u003c/span\u003e\n    \u003cspan style=\"color:#f92672\"\u003eansible_python_interpreter\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eauto_legacy_silent\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:playbook.yaml\" data-lang=\":playbook.yaml\"\u003e\n---\n- \u003cspan style=\"color:#f92672\"\u003ehosts\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eall\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003ebecome\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eyes\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003ebecome_method\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003esu\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003eroles\u003c/span\u003e:\n    - { \u003cspan style=\"color:#f92672\"\u003erole\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eatosatto.docker-swarm }\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n就這樣出發！！然後會出現兩個error\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ ansible-playbook playbook.yml -i hosts -K\n...\nTASK \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003eatosatto.docker-swarm : include_tasks\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e ***********************************************************************************************************************************************************************************************\nincluded: /home/zaq/.ansible/roles/atosatto.docker-swarm/tasks/setup-swarm-labels.yml \u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e manager01, worker01\n\nTASK \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003eatosatto.docker-swarm : Get list of labels.\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e *****************************************************************************************************************************************************************************************\nok: \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003emanager01 -\u0026gt; 192.168.149.131\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\nfatal: \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003eworker01 -\u0026gt; 192.168.149.131\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e: FAILED! \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;changed\u0026#34;\u003c/span\u003e: false, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cmd\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;docker\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;inspect\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;--format\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ range \u003c/span\u003e$key\u003cspan style=\"color:#e6db74\"\u003e, \u003c/span\u003e$value\u003cspan style=\"color:#e6db74\"\u003e := .Spec.Labels }}{{ printf \\\u0026#34;%s\\\\n\\\u0026#34; \u003c/span\u003e$key\u003cspan style=\"color:#e6db74\"\u003e }}{{ end }}\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;debian2.localdomain\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;delta\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;0:00:00.147106\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;end\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;2020-09-04 11:18:20.899896\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;non-zero return code\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rc\u0026#34;\u003c/span\u003e: 1, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;start\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;2020-09-04 11:18:20.752790\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stderr\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Error: No such object: debian2.localdomain\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stderr_lines\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Error: No such object: debian2.localdomain\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stdout\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stdout_lines\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#f92672\"\u003e[]}\u003c/span\u003e\n...\nfatal: \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003emanager01\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e: FAILED! \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;You need to install \\\u0026#34;jmespath\\\u0026#34; prior to running json_query filter\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n第二個比較簡單所以先解決，只是ansible machine缺了jmespath這個包\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# apt install python jmespath\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ ansible-playbook \n...\n$ ansible-playbook playbook.yml -i hosts -K\nBECOME password: \n\n...\nTASK \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003eatosatto.docker-swarm : Download docker-compose.\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e ************************************************************************************************************************************************************************************\nchanged: \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003emanager01\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\nPLAY RECAP *********************************************************************************************************************************************************************************************************************************\nmanager01                  : ok\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e35\u003c/span\u003e   changed\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e    unreachable\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    failed\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    skipped\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e25\u003c/span\u003e   rescued\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    ignored\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e   \nworker01                   : ok\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e27\u003c/span\u003e   changed\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    unreachable\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    failed\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e    skipped\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e20\u003c/span\u003e   rescued\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    ignored\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e   \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e就能繼續跑task了\n\u003cbr\u003e\u003c/br\u003e\n另一個問題相當顯而易見，主要是role的問題\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026quot;stderr\u0026quot;: \u0026quot;Error: No such object: debian2.localdomain\u0026quot;\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e可以看得出是docker inspect的指令找不到FQDN，因為這裡使用的是hostname\n\u003cbr\u003e\u003c/br\u003e\n接著來源頭找找，有三處的ansible_fqdn\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 1\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 2\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 3\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 4\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 5\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 6\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 7\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 8\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 9\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e10\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e11\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e12\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e13\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e14\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e15\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e16\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e17\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e18\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e19\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e20\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e21\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e22\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e23\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e24\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e25\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e26\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e27\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e28\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e29\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e30\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e31\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e32\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:~/.ansible/roles/atosatto.docker-swarm/tasks/setup-swarm-labels.yml\" data-lang=\":~/.ansible/roles/atosatto.docker-swarm/tasks/setup-swarm-labels.yml\"\u003e---\n\n- \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eGet list of labels.\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003ecommand\u003c/span\u003e: \u0026gt;-\u003cspan style=\"color:#e6db74\"\u003e\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e         docker inspect\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e         --format {% raw %}\u0026#39;{{ range $key, $value := .Spec.Labels }}{{ printf \u0026#34;%s\\n\u0026#34; $key }}{{ end }}\u0026#39;{% endraw %}\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"color:#e6db74\"\u003e         {{ ansible_fqdn|lower }}\u003c/span\u003e         \n\u003c/span\u003e  \u003cspan style=\"color:#f92672\"\u003eregister\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003edocker_swarm_labels\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003echanged_when\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003efalse\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_to\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ groups[\u0026#39;docker_swarm_manager\u0026#39;][0] }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_facts\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003etags\u003c/span\u003e:\n    - \u003cspan style=\"color:#ae81ff\"\u003eswarm_labels\u003c/span\u003e\n\n- \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eRemove labels from swarm node.\u003c/span\u003e\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e  \u003cspan style=\"color:#f92672\"\u003ecommand\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003edocker node update --label-rm {{ item }} {{ ansible_fqdn|lower }}\u003c/span\u003e\n\u003c/span\u003e  \u003cspan style=\"color:#f92672\"\u003ewith_items\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ docker_swarm_labels.stdout_lines }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003ewhen\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eitem not in swarm_labels\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_to\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ groups[\u0026#39;docker_swarm_manager\u0026#39;][0] }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_facts\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003etags\u003c/span\u003e:\n    - \u003cspan style=\"color:#ae81ff\"\u003eswarm_labels\u003c/span\u003e\n\n- \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eAssign labels to swarm nodes if any.\u003c/span\u003e\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e  \u003cspan style=\"color:#f92672\"\u003ecommand\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003edocker node update --label-add {{ item }}=true {{ ansible_fqdn|lower }}\u003c/span\u003e\n\u003c/span\u003e  \u003cspan style=\"color:#f92672\"\u003ewhen\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eitem not in docker_swarm_labels.stdout_lines\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003ewith_items\u003c/span\u003e:\n    - \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ swarm_labels  | default([]) }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_to\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ groups[\u0026#39;docker_swarm_manager\u0026#39;][0] }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_facts\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003etags\u003c/span\u003e:\n    - \u003cspan style=\"color:#ae81ff\"\u003eswarm_labels\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n只要修改成下面的樣子就沒問題了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 1\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 2\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 3\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 4\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 5\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 6\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 7\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 8\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 9\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e10\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e11\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e12\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e13\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e14\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e15\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e16\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e17\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e18\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e19\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e20\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e21\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e22\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e23\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e24\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e25\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e26\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e27\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e28\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e29\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e30\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e31\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e32\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:~/.ansible/roles/atosatto.docker-swarm/tasks/setup-swarm-labels.yml\" data-lang=\":~/.ansible/roles/atosatto.docker-swarm/tasks/setup-swarm-labels.yml\"\u003e---\n\n- \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eGet list of labels.\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003ecommand\u003c/span\u003e: \u0026gt;-\u003cspan style=\"color:#e6db74\"\u003e\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e         docker inspect\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e         --format {% raw %}\u0026#39;{{ range $key, $value := .Spec.Labels }}{{ printf \u0026#34;%s\\n\u0026#34; $key }}{{ end }}\u0026#39;{% endraw %}\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"color:#e6db74\"\u003e         {{ ansible_hostname|lower }}\u003c/span\u003e         \n\u003c/span\u003e  \u003cspan style=\"color:#f92672\"\u003eregister\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003edocker_swarm_labels\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003echanged_when\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003efalse\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_to\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ groups[\u0026#39;docker_swarm_manager\u0026#39;][0] }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_facts\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003etags\u003c/span\u003e:\n    - \u003cspan style=\"color:#ae81ff\"\u003eswarm_labels\u003c/span\u003e\n\n- \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eRemove labels from swarm node.\u003c/span\u003e\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e  \u003cspan style=\"color:#f92672\"\u003ecommand\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003edocker node update --label-rm {{ item }} {{ ansible_hostname|lower }}\u003c/span\u003e\n\u003c/span\u003e  \u003cspan style=\"color:#f92672\"\u003ewith_items\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ docker_swarm_labels.stdout_lines }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003ewhen\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eitem not in swarm_labels\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_to\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ groups[\u0026#39;docker_swarm_manager\u0026#39;][0] }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_facts\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003etags\u003c/span\u003e:\n    - \u003cspan style=\"color:#ae81ff\"\u003eswarm_labels\u003c/span\u003e\n\n- \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eAssign labels to swarm nodes if any.\u003c/span\u003e\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e  \u003cspan style=\"color:#f92672\"\u003ecommand\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003edocker node update --label-add {{ item }}=true {{ ansible_hostname|lower }}\u003c/span\u003e\n\u003c/span\u003e  \u003cspan style=\"color:#f92672\"\u003ewhen\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eitem not in docker_swarm_labels.stdout_lines\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003ewith_items\u003c/span\u003e:\n    - \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ swarm_labels  | default([]) }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_to\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{{ groups[\u0026#39;docker_swarm_manager\u0026#39;][0] }}\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003edelegate_facts\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003etags\u003c/span\u003e:\n    - \u003cspan style=\"color:#ae81ff\"\u003eswarm_labels\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n接著再嘗試一次\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e$ ansible-playbook playbook.yml -i hosts -K\n...\n\n\nPLAY RECAP *********************************************************************************************************************************************************************************************************************************\nmanager01                  : ok\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e35\u003c/span\u003e   changed\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    unreachable\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    failed\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    skipped\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e25\u003c/span\u003e   rescued\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    ignored\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e   \nworker01                   : ok\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e38\u003c/span\u003e   changed\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e    unreachable\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    failed\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    skipped\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e22\u003c/span\u003e   rescued\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e    ignored\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e   \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e成功！\n\u003cbr\u003e\u003c/br\u003e\n接下來也能到manager上確認一下狀況\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e$ docker node ls\nID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION\nhjlfykxsxlz5rzfcc17dvxsb7 *   debian1             Ready               Active              Leader              19.03.12\nwhhhx2g22eh1shn65wdwyx13k     debian2             Ready               Active                                  19.03.12\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e",
    "kind": "page",
    "params": {
      "categories": [
        "Deployment"
      ],
      "date": "2020-09-03T14:56:05+08:00",
      "draft": false,
      "iscjklanguage": true,
      "lastmod": "2020-09-03T14:56:05+08:00",
      "publishdate": "2020-09-03T14:56:05+08:00",
      "tags": [
        "Ansible",
        "Docker"
      ],
      "title": "使用Ansible部屬Docker Swarm"
    },
    "permalink": "https://mikanbearer.github.io/posts/2020/09/202009031456/index.json",
    "type": "posts",
    "wordcount": 1069
  }
}