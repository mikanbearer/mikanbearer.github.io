



    
        
    




{
  "result": {
    "content": "\u003cp\u003e這次嘗試使用VNC來使用遠端桌面，感覺未來會用到所以先筆記一下\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(1).offsetTop, behavior: 'smooth'})\"\u003e部屬VNC Server\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca onclick=\"window.scrollTo({top: document.getElementById(2).offsetTop, behavior: 'smooth'})\"\u003e使用noVNC進行連線\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003ch3 id=1\u003e部屬VNC Server\u003c/h3\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e使用的是CentOS 7\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# cat /etc/*-release\nCentOS Linux release 7.7.1908 (Core)\nNAME=\u0026quot;CentOS Linux\u0026quot;\nVERSION=\u0026quot;7 (Core)\u0026quot;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e如果沒GUI要先記得裝\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# yum groups install \u0026quot;GNOME Desktop\u0026quot;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e安裝本次的主角TigerVNC，雖然上述的GNOME Desktop應該就有包含了\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# yum install -y tigervnc-server\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e設定VNC密碼，之後就是用這密碼連線至指定的user\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# vncpasswd\nPassword:\nVerify:\nWould you like to enter a view-only password (y/n)? n\nA view-only password is not used\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e使用vncserver指令建立一個session來連線\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# vncserver :1\nxauth:  file /root/.Xauthority does not exist\n\nNew 'node1:1 (root)' desktop is node1:1\n\nCreating default startup script /root/.vnc/xstartup\nCreating default config /root/.vnc/config\nStarting applications specified in /root/.vnc/xstartup\nLog file is /root/.vnc/node1:1.log\n\n# vncserver -list\n\nTigerVNC server sessions:\n\nX DISPLAY #     PROCESS ID\n:1              33094\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e記得開通防火牆，port是5900+n，:1的話就是5901，:2就是5902，以此類推\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# firewall-cmd --permanent --add-port=5901/tcp\n# firewall-cmd --reload\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接下來就能用client連看看了，這裡用的是\u003ca target=\"_blank\" href=\"https://www.realvnc.com/en/\"\u003eRealVNC\u003c/a\u003e的VNC Viewer，首先新增連線\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e點選之後會警告未加密，但對於測試來說無傷大雅\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e輸入剛才的密碼就能看到GNOME的初始畫面\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e建立\u003ccode\u003e/etc/systemd/system/vncserver@:1.service\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-service\" data-lang=\"service\"\u003e\u003cspan style=\"color:#66d9ef\"\u003e[Unit]\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eDescription\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003eRemote desktop service (VNC)\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eAfter\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003esyslog.target network.target\u003c/span\u003e\n\n\u003cspan style=\"color:#66d9ef\"\u003e[Service]\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eType\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003esimple\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eUser\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003eroot\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ePAMName\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003elogin\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ePIDFile\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e/root/.vnc/%H:%i.pid\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eExecStartPre\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e/bin/sh -c \u0026#39;/usr/bin/vncserver -kill %i \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 || :\u0026#39;\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eExecStart\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e/usr/bin/vncserver -geometry 1440x900 -alwaysshared -fg %i\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eExecStop\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e/usr/bin/vncserver -kill %i\u003c/span\u003e\n\n\u003cspan style=\"color:#66d9ef\"\u003e[Install]\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eWantedBy\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003emulti-user.target\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003eSELinux會擋所以就改一下，懶得重開就用\u003ccode\u003e# setenforce 0\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-:/etc/sysconfig/selinux\" data-lang=\":/etc/sysconfig/selinux\"\u003eSELINUX=permissive\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e如此一來就service化了，可以設定開機自動啟動\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# systemctl daemon-reload\n# systemctl start vncserver@:1\n# systemctl enable vncserver@:1\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003ch3 id=2\u003e使用noVNC進行連線\u003c/h3\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e因browser無法直接使用vnc，所以需要一個轉換成websocket的proxy，首先下載noVNC，此為client用的web\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# git clone https://github.com/novnc/noVNC\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n可以使用以下指令啟動proxy，localhost可以是任何vnc server\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# cd noVNC\n# ./utils/launch.sh --vnc localhost:5901\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n沒有websockify的話會很貼心的自動clone\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003eWarning: could not find self.pem\nNo installed websockify, attempting to clone websockify...\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003eCloning into \u0026#39;/root/noVNC/utils/websockify\u0026#39;...\n\u003c/span\u003eremote: Enumerating objects: 9, done.\nremote: Counting objects: 100% (9/9), done.\nremote: Compressing objects: 100% (9/9), done.\nremote: Total 4217 (delta 3), reused 1 (delta 0), pack-reused 4208\nReceiving objects: 100% (4217/4217), 4.60 MiB | 1.62 MiB/s, done.\nResolving deltas: 100% (2773/2773), done.\nUsing local websockify at /root/noVNC/utils/websockify/run\nStarting webserver and WebSockets proxy on port 6080\nwebsockify/websocket.py:30: UserWarning: no \u0026#39;numpy\u0026#39; module, HyBi protocol will be slower\n  warnings.warn(\u0026#34;no \u0026#39;numpy\u0026#39; module, HyBi protocol will be slower\u0026#34;)\nWebSocket server settings:\n  - Listen on :6080\n  - Web server. Web root: /root/noVNC\n  - No SSL/TLS support (no cert file)\n  - proxying from :6080 to localhost:5901\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n如此就能使用noVNC client了，url由query string來決定目標VNC Server\u003c/p\u003e\n\u003cp\u003e如\u003ccode\u003ehttp://192.168.149.131:6080/vnc.html?host=192.168.149.131\u0026amp;port=6080\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e登入一樣需要輸入VNC的密碼\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"5.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cbr\u003e\n\u003cp\u003e接下來換成token來連接VNC Server如此可以用一個port對應複數的VNC，首先建立一個清單，檔名可以隨意\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-:token.conf\" data-lang=\":token.conf\"\u003e123456: 192.168.149.131:5901\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接下來就直接使用websockify指令，偷懶直接用剛才launch.sh自動clone的，如果同時需要web的話需要\u003ccode\u003e--web\u003c/code\u003e這個option，同時建議指定絕對路徑，此為vnc.html的所在位置，否則當前目錄會以websockify所在的目錄\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# ./utils/websockify/websockify.py --web /root/noVNC --target-config=/root/token.conf 6080\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\u003c/p\u003e\n\u003cp\u003e接下來就一樣打上網址，query string改為path=websockify/?token=\u003ctoken\u003e，如此一來就能透過token連接不同的VNC Server了，\n這個檔案是收到request的時候才會讀取的，所以websockify就算啟動中也能即刻生效，可作為安全性的方案\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"6.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cbr\u003e\u003c/br\u003e\n完工\u003c/p\u003e",
    "kind": "page",
    "params": {
      "categories": [
        "Operation"
      ],
      "date": "2020-11-20T14:50:47+08:00",
      "draft": false,
      "iscjklanguage": true,
      "lastmod": "2020-11-20T14:50:47+08:00",
      "publishdate": "2020-11-20T14:50:47+08:00",
      "tags": [
        "TigerVNC",
        "noVNC"
      ],
      "title": "使用noVNC遠端連線至CentOS"
    },
    "permalink": "https://mikanbearer.github.io/posts/2020/11/202011201450/index.json",
    "type": "posts",
    "wordcount": 1250
  }
}