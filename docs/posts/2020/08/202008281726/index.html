<p>為了之後的學習方向做準備，來練習一下Scrapy，Scrapy就是處理response的工具，並從中取得自己需要的資料，</p>
<p>這次就做個最低限度的練習</p>
<p>這次主要接觸的就以下三者：</p>
<ul>
<li>Spider
<ul>
<li>用於爬網站</li>
</ul>
</li>
<li>Item
<ul>
<li>將爬到的東西構造話的資料模型</li>
</ul>
</li>
<li>Pipeline
<ul>
<li>處理Spider回傳的Item
<br></br></li>
</ul>
</li>
</ul>
<p>開始動手囉
<br></br></p>
<h3 id="事前準備">事前準備</h3>
<hr>
<p><br></br>
首先安裝必要的包</p>
<pre><code>pip install Scrapy
</code></pre><p><br></br>
接下來就可以用指令建立project</p>
<pre><code>$ scrapy startproject scrapy_toturial
</code></pre><p><br></br>
project目錄下的樹狀圖是這樣的</p>
<pre><code>scrapy_tutorial
│  scrapy.cfg
│
└─scrapy_tutorial
    │  items.py
    │  middlewares.py
    │  pipelines.py
    │  settings.py
    │  __init__.py
    │
    └─spiders
            __init__.py
</code></pre><p>接下來就可以開始動手做啦
<br></br></p>
<h3 id="建立一個spider">建立一個Spider</h3>
<hr>
<p><br></br>
接下來就是建立spider了，spider就是負責取得response的關鍵，範例就這個很久沒更新的<a href="https://hugo-theme-ranking.oika.me/">hugo theme ranking</a>吧！</p>
<p>輸入以下指令就會在當前目錄建立spider，為求整齊，建立在/spiders底下</p>
<pre><code>$ scrapy genspider hugo_ranking https://hugo-theme-ranking.oika.me/
</code></pre><p><br></br>
現在的樹狀圖會是這樣</p>
<pre><code>scrapy_tutorial
│  scrapy.cfg
│
└─scrapy_tutorial
    │  items.py
    │  middlewares.py
    │  pipelines.py
    │  settings.py
    │  __init__.py
    │
    └─spiders
            hugo_ranking.py ★
            __init__.py

</code></pre><p><br></br>
預設的spider是這個樣子，一切的關鍵就在於這個parse()</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:scrapy_toturial/spiders/hugo_ranking.py" data-lang=":scrapy_toturial/spiders/hugo_ranking.py"><span style="color:#f92672">import</span> scrapy


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HugoRankingSpider</span>(scrapy<span style="color:#f92672">.</span>Spider):
    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hugo_ranking&#39;</span>
    allowed_domains <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;hugo-theme-ranking.oika.me&#39;</span>]
    start_urls <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;http://hugo-theme-ranking.oika.me/&#39;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse</span>(self, response):
        <span style="color:#66d9ef">pass</span>
</code></pre></td></tr></table>
</div>
</div><p><br></br>
也可以用指令列出當前project的spiders</p>
<pre><code>$ scrapy list
hugo_ranking
</code></pre><p><br></br>
接下來就可以「爬」一遍啦</p>
<pre><code>$ scrapy crawl hugo_ranking
...
 'start_time': datetime.datetime(2020, 8, 31, 5, 56, 48, 766086)}
2020-08-31 13:56:51 [scrapy.core.engine] INFO: Spider closed (finished)

</code></pre><p>當然除了log外是沒輸出的，因為parse()的內容還沒定義
<br></br>
主要需要coding的是這個地方，像以下的範例，會將html以text的格式print出來，也就是stdout</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:scrapy_toturial/spiders/hugo_ranking.py" data-lang=":scrapy_toturial/spiders/hugo_ranking.py"><span style="color:#f92672">import</span> scrapy


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HugoRankingSpider</span>(scrapy<span style="color:#f92672">.</span>Spider):
    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hugo_ranking&#39;</span>
    allowed_domains <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;hugo-theme-ranking.oika.me&#39;</span>]
    start_urls <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;http://hugo-theme-ranking.oika.me/&#39;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse</span>(self, response):
<span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#66d9ef">print</span>(response<span style="color:#f92672">.</span>text)
</span></code></pre></td></tr></table>
</div>
</div><p><br></br>
當然也能用open把html存成檔案</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:scrapy_toturial/spiders/hugo_ranking.py" data-lang=":scrapy_toturial/spiders/hugo_ranking.py"><span style="color:#f92672">import</span> scrapy


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HugoRankingSpider</span>(scrapy<span style="color:#f92672">.</span>Spider):
    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hugo_ranking&#39;</span>
    allowed_domains <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;hugo-theme-ranking.oika.me&#39;</span>]
    start_urls <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;http://hugo-theme-ranking.oika.me/&#39;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse</span>(self, response):
<span style="display:block;width:100%;background-color:#3c3d38">        filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">.html&#39;</span> <span style="color:#f92672">%</span> response<span style="color:#f92672">.</span>url<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]
</span><span style="display:block;width:100%;background-color:#3c3d38">        f <span style="color:#f92672">=</span> open(filename, <span style="color:#e6db74">&#39;wb&#39;</span>)
</span><span style="display:block;width:100%;background-color:#3c3d38">        f<span style="color:#f92672">.</span>write(response<span style="color:#f92672">.</span>body)
</span></code></pre></td></tr></table>
</div>
</div><p><br></br>
可以開始試著抓資料囉，接著就是用selector來取得自己想要的部分，這次的範例就先參考list</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">...

						&lt;<span style="color:#f92672">ul</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;theme-list&#34;</span>&gt;
							&lt;<span style="color:#f92672">li</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;theme-item&#34;</span>&gt;
								&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;theme-border&#34;</span>&gt;
									&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://themes.gohugo.io/academic/&#34;</span> <span style="color:#a6e22e">target</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;_blank&#34;</span> <span style="color:#a6e22e">rel</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;noopener&#34;</span>&gt;&lt;<span style="color:#f92672">img</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;images\thums\Academic.png&#34;</span>/&gt;&lt;/<span style="color:#f92672">a</span>&gt;
									&lt;<span style="color:#f92672">span</span>&gt;
										&lt;<span style="color:#f92672">span</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;theme-label&#34;</span>&gt;1. &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://themes.gohugo.io/academic/&#34;</span> <span style="color:#a6e22e">target</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;_blank&#34;</span>&gt;Academic&lt;/<span style="color:#f92672">a</span>&gt; (&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/gcushen/hugo-academic.git&#34;</span>&gt;3065&lt;/<span style="color:#f92672">a</span>&gt;)&lt;/<span style="color:#f92672">span</span>&gt;
										&lt;<span style="color:#f92672">span</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;tags&#34;</span>&gt;#academic #portfolio #responsive #student #personal #university #blog #minimal&lt;/<span style="color:#f92672">span</span>&gt;
									&lt;/<span style="color:#f92672">span</span>&gt;
								&lt;/<span style="color:#f92672">div</span>&gt;
							&lt;/<span style="color:#f92672">li</span>&gt;
...
</code></pre></div><p><br></br>
下面的範例就是用yield，讓parse()成為一個generator，回傳的值會是dict</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:scrapy_toturial/spiders/hugo_ranking.py" data-lang=":scrapy_toturial/spiders/hugo_ranking.py"><span style="color:#f92672">import</span> scrapy

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HugoRankingSpider</span>(scrapy<span style="color:#f92672">.</span>Spider):
    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hugo_ranking&#39;</span>
    allowed_domains <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;hugo-theme-ranking.oika.me&#39;</span>]
    start_urls <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;http://hugo-theme-ranking.oika.me/&#39;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse</span>(self, response):

        <span style="color:#66d9ef">for</span> theme <span style="color:#f92672">in</span> response<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;li.theme-item&#39;</span>):
<span style="display:block;width:100%;background-color:#3c3d38">            <span style="color:#66d9ef">yield</span> {
</span><span style="display:block;width:100%;background-color:#3c3d38">                <span style="color:#e6db74">&#39;neme&#39;</span>: theme<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;span.theme-label a::text&#39;</span>)<span style="color:#f92672">.</span>get(),
</span><span style="display:block;width:100%;background-color:#3c3d38">                <span style="color:#e6db74">&#39;url&#39;</span>:  theme<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;span.theme-label a::attr(href)&#39;</span>)<span style="color:#f92672">.</span>get(),
</span><span style="display:block;width:100%;background-color:#3c3d38">                <span style="color:#e6db74">&#39;star&#39;</span>: theme<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;span.theme-label a:nth-child(2)::text&#39;</span>)<span style="color:#f92672">.</span>get(),
</span><span style="display:block;width:100%;background-color:#3c3d38">                <span style="color:#e6db74">&#39;tags&#39;</span>: theme<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;span.tags::text&#39;</span>)<span style="color:#f92672">.</span>get(),
</span><span style="display:block;width:100%;background-color:#3c3d38">            }
</span></code></pre></td></tr></table>
</div>
</div><p><br></br>
輸出就會像這樣子，看得出有抓到想要的東西了</p>
<pre><code>2020-08-31 15:50:55 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://hugo-theme-ranking.oika.me/&gt;
{'neme': 'Academic', 'url': 'https://themes.gohugo.io/academic/', 'star': '3065', 'tags': ['#academic', '#portfolio', '#responsive', '#student', '#personal', '#university', '#blog', '#minimal']}
2020-08-31 15:50:55 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://hugo-theme-ranking.oika.me/&gt;
{'neme': 'Learn', 'url': 'https://themes.gohugo.io/hugo-theme-learn/', 'star': '692', 'tags': ['#documentation', '#grav', '#learn', '#doc', '#search']}
2020-08-31 15:50:55 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://hugo-theme-ranking.oika.me/&gt;

</code></pre><p><br></br></p>
<h3 id="使用items">使用Items</h3>
<hr>
<p><br></br>
接下來加入Item的部分，其實這東西就是一個model，裡面就定義好自己所需的field</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:scrapy_toturial/items.py" data-lang=":scrapy_toturial/items.py"><span style="color:#75715e"># Define here the models for your scraped items</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># See documentation in:</span>
<span style="color:#75715e"># https://docs.scrapy.org/en/latest/topics/items.html</span>

<span style="color:#f92672">import</span> scrapy


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScrapyTutorialItem</span>(scrapy<span style="color:#f92672">.</span>Item):
    <span style="color:#75715e"># define the fields for your item here like:</span>
    <span style="color:#75715e"># name = scrapy.Field()</span>
<span style="display:block;width:100%;background-color:#3c3d38">    name <span style="color:#f92672">=</span> scrapy<span style="color:#f92672">.</span>Field()
</span><span style="display:block;width:100%;background-color:#3c3d38">    url <span style="color:#f92672">=</span> scrapy<span style="color:#f92672">.</span>Field()
</span><span style="display:block;width:100%;background-color:#3c3d38">    star <span style="color:#f92672">=</span> scrapy<span style="color:#f92672">.</span>Field()
</span><span style="display:block;width:100%;background-color:#3c3d38">    tags <span style="color:#f92672">=</span> scrapy<span style="color:#f92672">.</span>Field()
</span></code></pre></td></tr></table>
</div>
</div><p><br></br>
將剛才定義的item導入spider，一樣用generator</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:scrapy_toturial/spiders/hugo_ranking.py" data-lang=":scrapy_toturial/spiders/hugo_ranking.py"><span style="color:#f92672">import</span> scrapy
<span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#f92672">from</span> ..items <span style="color:#f92672">import</span> ScrapyTutorialItem
</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HugoRankingSpider</span>(scrapy<span style="color:#f92672">.</span>Spider):
    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hugo_ranking&#39;</span>
    allowed_domains <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;hugo-theme-ranking.oika.me&#39;</span>]
    start_urls <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;http://hugo-theme-ranking.oika.me/&#39;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse</span>(self, response):
<span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#66d9ef">for</span> theme <span style="color:#f92672">in</span> response<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;li.theme-item&#39;</span>):
</span><span style="display:block;width:100%;background-color:#3c3d38">            item <span style="color:#f92672">=</span> ScrapyTutorialItem()
</span><span style="display:block;width:100%;background-color:#3c3d38">
</span><span style="display:block;width:100%;background-color:#3c3d38">            item[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> theme<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;span.theme-label a::text&#39;</span>)<span style="color:#f92672">.</span>get()
</span><span style="display:block;width:100%;background-color:#3c3d38">            item[<span style="color:#e6db74">&#39;url&#39;</span>] <span style="color:#f92672">=</span> theme<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;span.theme-label a::attr(href)&#39;</span>)<span style="color:#f92672">.</span>get()
</span><span style="display:block;width:100%;background-color:#3c3d38">            item[<span style="color:#e6db74">&#39;star&#39;</span>] <span style="color:#f92672">=</span> theme<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;span.theme-label a:nth-child(2)::text&#39;</span>)<span style="color:#f92672">.</span>get()
</span><span style="display:block;width:100%;background-color:#3c3d38">            item[<span style="color:#e6db74">&#39;tags&#39;</span>] <span style="color:#f92672">=</span> theme<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#39;span.tags::text&#39;</span>)<span style="color:#f92672">.</span>get()
</span><span style="display:block;width:100%;background-color:#3c3d38">
</span><span style="display:block;width:100%;background-color:#3c3d38">            <span style="color:#66d9ef">yield</span> item
</span></code></pre></td></tr></table>
</div>
</div><p><br></br>
然後使用指令就能輸出json了</p>
<pre><code>$ scrapy crawl hugo_ranking -o data.json
</code></pre><p><br></br>
可以驗收一下成果</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">[
{<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Academic&#34;</span>, <span style="color:#f92672">&#34;url&#34;</span>: <span style="color:#e6db74">&#34;https://themes.gohugo.io/academic/&#34;</span>, <span style="color:#f92672">&#34;star&#34;</span>: <span style="color:#e6db74">&#34;3065&#34;</span>, <span style="color:#f92672">&#34;tags&#34;</span>: <span style="color:#e6db74">&#34;#academic #portfolio #responsive #student #personal #university #blog #minimal&#34;</span>},
{<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Learn&#34;</span>, <span style="color:#f92672">&#34;url&#34;</span>: <span style="color:#e6db74">&#34;https://themes.gohugo.io/hugo-theme-learn/&#34;</span>, <span style="color:#f92672">&#34;star&#34;</span>: <span style="color:#e6db74">&#34;692&#34;</span>, <span style="color:#f92672">&#34;tags&#34;</span>: <span style="color:#e6db74">&#34;#documentation #grav #learn #doc #search&#34;</span>},
{<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Even&#34;</span>, <span style="color:#f92672">&#34;url&#34;</span>: <span style="color:#e6db74">&#34;https://themes.gohugo.io/hugo-theme-even/&#34;</span>, <span style="color:#f92672">&#34;star&#34;</span>: <span style="color:#e6db74">&#34;654&#34;</span>, <span style="color:#f92672">&#34;tags&#34;</span>: <span style="color:#e6db74">&#34;#responsive #blog #simple #clean #highlight.js #syntax highlighting&#34;</span>},
{<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Tranquilpeak&#34;</span>, <span style="color:#f92672">&#34;url&#34;</span>: <span style="color:#e6db74">&#34;https://themes.gohugo.io/hugo-tranquilpeak-theme/&#34;</span>, <span style="color:#f92672">&#34;star&#34;</span>: <span style="color:#e6db74">&#34;516&#34;</span>, <span style="color:#f92672">&#34;tags&#34;</span>: <span style="color:#e6db74">&#34;#blog #minimal #responsive #personal #customizable #creative #fontawesome #highlight.js&#34;</span>},

<span style="color:#960050;background-color:#1e0010">...</span>

]
</code></pre></div><p><br></br></p>
<h3 id="使用pipeline">使用Pipeline</h3>
<hr>
<p><br></br>
使用Item其實也就是方便整理資料，為了將爬出來的東西複用，接下來就能用pipeline來處理這個item該做些什麼，首先修改setting</p>
<p>當初建立project的時候這行就自動產生了，只要取消註解便可
<br></br></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:scrapy_toturial/settings.py" data-lang=":scrapy_toturial/settings.py"><span style="display:block;width:100%;background-color:#3c3d38">ITEM_PIPELINES <span style="color:#f92672">=</span> {
</span><span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#39;scrapy_tutorial.pipelines.ScrapyTutorialPipeline&#39;</span>: <span style="color:#ae81ff">300</span>,
</span><span style="display:block;width:100%;background-color:#3c3d38">}
</span></code></pre></td></tr></table>
</div>
</div><p><br></br>
接下來就是定義pipeline了，當初我們使用generator就是為此，這樣parse()執行一次，就會將item交由process_item()處理，像以下範例就能存到sqlite3內</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:scrapy_toturial/pipelines.py" data-lang=":scrapy_toturial/pipelines.py"><span style="color:#f92672">from</span> itemadapter <span style="color:#f92672">import</span> ItemAdapter
<span style="color:#f92672">import</span> sqlite3


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScrapyTutorialPipeline</span>:
    conn <span style="color:#f92672">=</span> None

    <span style="color:#a6e22e">@classmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_database</span>(cls):
        cls<span style="color:#f92672">.</span>conn <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>connect(<span style="color:#e6db74">&#39;items.db&#39;</span>)

        cursor <span style="color:#f92672">=</span> cls<span style="color:#f92672">.</span>conn<span style="color:#f92672">.</span>cursor()
        cursor<span style="color:#f92672">.</span>execute(
            <span style="color:#e6db74">&#39;CREATE TABLE IF NOT EXISTS theme(</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">                id INTEGER PRIMARY KEY AUTOINCREMENT, </span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">                name TEXT NOT NULL, </span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">                url TEXT, </span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">                star INTEGER, </span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">                tags TEXT</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            );&#39;</span>)

        <span style="color:#66d9ef">return</span> cls<span style="color:#f92672">.</span>conn

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_item</span>(self, item, spider):
        self<span style="color:#f92672">.</span>save_item(item)
        <span style="color:#66d9ef">return</span> item

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_item</span>(self, item):
        db <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_database()
        db<span style="color:#f92672">.</span>execute(
            <span style="color:#e6db74">&#39;INSERT INTO theme(name, url, star, tags) VALUES (?, ?, ?, ?)&#39;</span>,
            tuple(ItemAdapter(item)<span style="color:#f92672">.</span>values())
        )
        db<span style="color:#f92672">.</span>commit()
</code></pre></td></tr></table>
</div>
</div><p><br></br>
然後就能打開shell驗收了</p>
<pre><code>&gt;&gt;&gt; import sqlite3
&gt;&gt;&gt; db = sqlite3.connect('scrapy_tutorial/scrapy_tutorial/spiders/items.db')
&gt;&gt;&gt; record = db.execute('select * from theme')
&gt;&gt;&gt; record.fetchall()
[(1, 'Academic', 'https://themes.gohugo.io/academic/', 3065, '#academic #portfolio #responsive #stu
</code></pre><p>練習完收工</p>


<v-card class="mt-5 content">
  <v-card-text>
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mikanmimi" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </v-card-text>
</v-card>
