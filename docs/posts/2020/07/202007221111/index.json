



    
        
    




{
  "result": {
    "content": "\u003cp\u003e本篇旨在project中增加異步執行的功能，增進使用者體驗，避免東西沒跑完response等了老半天等不到的窘境，\n目前只提供簡單的範例，不包含異步任務的情境應用\u003c/p\u003e\n\u003cp\u003esource code一樣放在github\n\u003ca target=\"_blank\" href=\"https://github.com/mikanbearer/django_celery_example\"\u003e傳送門\u003c/a\u003e\n這次需要這幾個包\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003epip install django celery django-celery-results\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e目前環境如下\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ python --version\r\nPython 3.6.8\r\n\r\n$ pip list\r\n...\r\ncelery                  4.4.1\r\nDjango                  3.0\r\ndjango-celery-results   1.2.1\r\n...\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e首先在settings中加上celery及django_celery_results需要的設定\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e33\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e34\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e35\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e36\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e37\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e38\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e39\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e40\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e41\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:django_celery_example/settings.py\" data-lang=\":django_celery_example/settings.py\"\u003eINSTALLED_APPS \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.admin\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.auth\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.contenttypes\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.sessions\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.messages\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.staticfiles\u0026#39;\u003c/span\u003e,\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django_celery_results\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e]\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e網路上的資料多半是redis，那這次個人就用amqp，部屬就不贅述\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e124\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e125\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e126\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e127\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e128\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:django_celery_example/settings.py\" data-lang=\":django_celery_example/settings.py\"\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003eCELERY_BROKER_URL \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;amqp://guest:guest@127.0.0.1\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003eCELERY_RESULT_BACKEND \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django-db\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003eCELERY_CACHE_BACKEND \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django-cache\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e建立table\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ python manage.py migrate\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ca href=\"https://docs.celeryproject.org/en/stable/django/first-steps-with-django.html\"\u003e\u003ca href=\"https://docs.celeryproject.org/en/stable/django/first-steps-with-django.html\"\u003ehttps://docs.celeryproject.org/en/stable/django/first-steps-with-django.html\u003c/a\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 1\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 2\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 3\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 4\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 5\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 6\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 7\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 8\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 9\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e10\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e11\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e12\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e13\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e14\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e15\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e16\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e17\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e18\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e19\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e20\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e21\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e22\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e23\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e24\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:django_celery_example/celery.py\" data-lang=\":django_celery_example/celery.py\"\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e __future__ \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e absolute_import, unicode_literals\n\n\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e os\n\n\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e celery \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e Celery\n\n\u003cspan style=\"color:#75715e\"\u003e# set the default Django settings module for the \u0026#39;celery\u0026#39; program.\u003c/span\u003e\nos\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eenviron\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esetdefault(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;DJANGO_SETTINGS_MODULE\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django_celery_example.settings\u0026#39;\u003c/span\u003e)\n\napp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Celery(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django_celery_example\u0026#39;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Using a string here means the worker doesn\u0026#39;t have to serialize\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# the configuration object to child processes.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# - namespace=\u0026#39;CELERY\u0026#39; means all celery-related configuration keys\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#   should have a `CELERY_` prefix.\u003c/span\u003e\napp\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003econfig_from_object(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.conf:settings\u0026#39;\u003c/span\u003e, namespace\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;CELERY\u0026#39;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Load task modules from all registered Django app configs.\u003c/span\u003e\napp\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eautodiscover_tasks()\n\n\n\u003cspan style=\"color:#a6e22e\"\u003e@app.task\u003c/span\u003e(bind\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eTrue)\n\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edebug_task\u003c/span\u003e(self):\n    \u003cspan style=\"color:#66d9ef\"\u003eprint\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;Request: {0!r}\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eformat(self\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003erequest))\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cpre\u003e\u003ccode\u003ecelery -A django_celery_example worker --pool=solo -l info\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e可以用django shell測試\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ python manage.py shell\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e可以用sync的方式直接執行django_celery_example/celery.py當初裡面的debug_task\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026gt;\u0026gt;\u0026gt; from django_celery_example.celery import debug_task\r\n\u0026gt;\u0026gt;\u0026gt; debug_task()\r\nRequest: \u0026lt;Context: {'args': (), 'kwargs': {}}\u0026gt;\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e也可以使用async方式執行，只要使用delay這個method，並使用TaskResult這個model來看結果\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026gt;\u0026gt;\u0026gt; debug_task.delay()\r\n\u0026lt;AsyncResult: d988824b-5613-4f2d-8034-e3eb69a43fd7\u0026gt;\r\n\u0026gt;\u0026gt;\u0026gt; from django_celery_results.models import TaskResult\r\n\u0026gt;\u0026gt;\u0026gt; TaskResults.objects.all()\r\n\u0026lt;QuerySet [\u0026lt;TaskResult: \u0026lt;Task: d988824b-5613-4f2d-8034-e3eb69a43fd7 (SUCCESS)\u0026gt;\u0026gt;]\u0026gt;\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e而celery的stdout也會有相應的info\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[2020-07-22 14:12:01,565: INFO/MainProcess] Received task: django_celery_example.celery.debug_task[d988824b-5613-4f2d-8034-e3eb69a43fd7]\r\n[2020-07-22 14:12:01,566: WARNING/MainProcess] Request: \u0026lt;Context: {'lang': 'py', 'task': 'django_celery_example.celery.debug_task', 'id': 'd988824b-5613-4f2d-8034-e3eb69a43fd7', 'shadow': None, 'eta': None, 'ex\r\npires': None, 'group': None, 'retries': 0, 'timelimit': [None, None], 'root_id': 'd988824b-5613-4f2d-8034-e3eb69a43fd7', 'parent_id': None, 'argsrepr': '()', 'kwargsrepr': '{}', 'origin': 'gen10892@ABRACADABRA'\r\n, 'reply_to': '57a2696a-9b60-32f2-8cbc-66ec2fb60cea', 'correlation_id': 'd988824b-5613-4f2d-8034-e3eb69a43fd7', 'hostname': 'celery@ABRACADABRA', 'delivery_info': {'exchange': '', 'routing_key': 'celery', 'prio\r\nrity': 0, 'redelivered': False}, 'args': [], 'kwargs': {}, 'is_eager': False, 'callbacks': None, 'errbacks': None, 'chain': None, 'chord': None, 'called_directly': False, '_protected': 1}\u0026gt;\r\n[2020-07-22 14:12:01,587: INFO/MainProcess] Task django_celery_example.celery.debug_task[d988824b-5613-4f2d-8034-e3eb69a43fd7] succeeded in 0.01599999999962165s: None\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e這樣就能確定我們的task queue在正常運作了\u003c/p\u003e\n\u003cp\u003e接下來要在自己的app內登錄task，首先建立app\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ python manage.py startapp demoapp\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e加進settings.py\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e33\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e34\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e35\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e36\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e37\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e38\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e39\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e40\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e41\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e42\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:django_celery_example/settings.py\" data-lang=\":django_celery_example/settings.py\"\u003eINSTALLED_APPS \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.admin\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.auth\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.contenttypes\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.sessions\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.messages\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.contrib.staticfiles\u0026#39;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django_celery_results\u0026#39;\u003c/span\u003e,\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;demoapp\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e]\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e一樣在celery.py加上剛才建立的app\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e16\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e17\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e18\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e19\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e20\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:django_celery_example/celery.py\" data-lang=\":django_celery_example/celery.py\"\u003eapp\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003econfig_from_object(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;django.conf:settings\u0026#39;\u003c/span\u003e, namespace\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;CELERY\u0026#39;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Load task modules from all registered Django app configs.\u003c/span\u003e\n\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003eapp\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eautodiscover_tasks([\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;demoapp\u0026#39;\u003c/span\u003e])\n\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e在__init__.py增加以下內容，這樣才會讀取加上@shared_task這個decotator的task\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e2\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e3\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e4\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e5\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e6\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e7\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:django_celery_example/__init__.py\" data-lang=\":django_celery_example/__init__.py\"\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e __future__ \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e absolute_import, unicode_literals\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"color:#75715e\"\u003e# This will make sure the app is always imported when\u003c/span\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Django starts so that shared_task will use this app.\u003c/span\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e .celery \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e app \u003cspan style=\"color:#66d9ef\"\u003eas\u003c/span\u003e celery_app\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e\n\u003c/span\u003e\u003cspan style=\"display:block;width:100%;background-color:#3c3d38\"\u003e__all__ \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;celery_app\u0026#39;\u003c/span\u003e,)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e接下來建立task，先偷懶不使用model\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 1\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 2\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 3\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 4\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 5\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 6\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 7\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 8\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 9\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e10\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e11\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e12\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e13\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e14\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e15\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e16\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e17\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e18\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e19\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-:demoapp/tasks.py\" data-lang=\":demoapp/tasks.py\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Create your tasks here\u003c/span\u003e\n\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e __future__ \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e absolute_import, unicode_literals\n\n\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e celery \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e shared_task\n\n\n\u003cspan style=\"color:#a6e22e\"\u003e@shared_task\u003c/span\u003e\n\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eadd\u003c/span\u003e(x, y):\n    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e x \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e y\n\n\n\u003cspan style=\"color:#a6e22e\"\u003e@shared_task\u003c/span\u003e\n\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emul\u003c/span\u003e(x, y):\n    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e x \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e y\n\n\n\u003cspan style=\"color:#a6e22e\"\u003e@shared_task\u003c/span\u003e\n\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003exsum\u003c/span\u003e(numbers):\n    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e sum(numbers)\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e再啟動celery，就會發現多出不同的東西了\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ celery -A django_celery_example worker --pool=solo -l info\r\n...\r\n[tasks]\r\n  . demoapp.tasks.add\r\n  . demoapp.tasks.mul\r\n  . demoapp.tasks.xsum\r\n  . django_celery_example.celery.debug_task\r\n\r\n...\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e剛才的task已經進來了，接下來就能用shell測試\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026gt;\u0026gt;\u0026gt; from demoapp import tasks\r\n\u0026gt;\u0026gt;\u0026gt; tasks.add.delay(1, 1)\r\n\u0026lt;AsyncResult: 9729c417-9fb1-4868-a884-eeeea4faa125\u0026gt;\r\n\u0026gt;\u0026gt;\u0026gt; tasks.mul.delay(9, 9)\r\n\u0026lt;AsyncResult: 1ac747d8-bff1-46ef-8b0b-0efdeb1f925c\u0026gt;\r\n\u0026gt;\u0026gt;\u0026gt; from django_celery_results.models import TaskResult\r\n\u0026gt;\u0026gt;\u0026gt; TaskResult.objects.all()\r\n\u0026lt;QuerySet [\u0026lt;TaskResult: \u0026lt;Task: 1ac747d8-bff1-46ef-8b0b-0efdeb1f925c (SUCCESS)\u0026gt;\u0026gt;, \u0026lt;TaskResult: \u0026lt;Task: 9729c417-9fb1-4868-a884-eeeea4faa125 (SUCCESS)\u0026gt;\u0026gt;]\u0026gt;\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e也能很簡單的取出結果\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026gt;\u0026gt;\u0026gt; TaskResult.objects.get(task_id='1ac747d8-bff1-46ef-8b0b-0efdeb1f925c').result\r\n'81'\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e完\u003c/p\u003e",
    "kind": "page",
    "params": {
      "categories": [
        "Web Development"
      ],
      "date": "2020-07-22T11:11:37+08:00",
      "draft": false,
      "iscjklanguage": true,
      "lastmod": "2020-07-22T11:11:37+08:00",
      "publishdate": "2020-07-22T11:11:37+08:00",
      "tags": [
        "Celery",
        "Django",
        "Python"
      ],
      "title": "使用Django + Celery進行異步處理"
    },
    "permalink": "https://mikanbearer.github.io/posts/2020/07/202007221111/index.json",
    "type": "posts",
    "wordcount": 1057
  }
}