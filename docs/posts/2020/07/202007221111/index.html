<p>本篇旨在project中增加異步執行的功能，增進使用者體驗，避免東西沒跑完response等了老半天等不到的窘境，
目前只提供簡單的範例，不包含異步任務的情境應用</p>
<p>source code一樣放在github
<a href="https://github.com/mikanbearer/django_celery_example">https://github.com/mikanbearer/django_celery_example</a>
這次需要這幾個包</p>
<pre><code>pip install django celery django-celery-results
</code></pre><p>目前環境如下</p>
<pre><code>$ python --version
Python 3.6.8

$ pip list
...
celery                  4.4.1
Django                  3.0
django-celery-results   1.2.1
...
</code></pre><p>首先在settings中加上celery及django_celery_results需要的設定</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_celery_example/settings.py" data-lang=":django_celery_example/settings.py">INSTALLED_APPS <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;django.contrib.admin&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.auth&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.contenttypes&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.sessions&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.messages&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.staticfiles&#39;</span>,
<span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#39;django_celery_results&#39;</span>,
</span>]
</code></pre></td></tr></table>
</div>
</div><p>網路上的資料多半是redis，那這次個人就用amqp，部屬就不贅述</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_celery_example/settings.py" data-lang=":django_celery_example/settings.py"><span style="display:block;width:100%;background-color:#3c3d38">CELERY_BROKER_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amqp://guest:guest@127.0.0.1&#39;</span>
</span>
<span style="display:block;width:100%;background-color:#3c3d38">CELERY_RESULT_BACKEND <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;django-db&#39;</span>
</span>
<span style="display:block;width:100%;background-color:#3c3d38">CELERY_CACHE_BACKEND <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;django-cache&#39;</span>
</span></code></pre></td></tr></table>
</div>
</div><p>建立table</p>
<pre><code>$ python manage.py migrate
</code></pre><p><a href="https://docs.celeryproject.org/en/stable/django/first-steps-with-django.html"><a href="https://docs.celeryproject.org/en/stable/django/first-steps-with-django.html">https://docs.celeryproject.org/en/stable/django/first-steps-with-django.html</a></a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_celery_example/celery.py" data-lang=":django_celery_example/celery.py"><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> absolute_import, unicode_literals

<span style="color:#f92672">import</span> os

<span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery

<span style="color:#75715e"># set the default Django settings module for the &#39;celery&#39; program.</span>
os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>setdefault(<span style="color:#e6db74">&#39;DJANGO_SETTINGS_MODULE&#39;</span>, <span style="color:#e6db74">&#39;django_celery_example.settings&#39;</span>)

app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;django_celery_example&#39;</span>)

<span style="color:#75715e"># Using a string here means the worker doesn&#39;t have to serialize</span>
<span style="color:#75715e"># the configuration object to child processes.</span>
<span style="color:#75715e"># - namespace=&#39;CELERY&#39; means all celery-related configuration keys</span>
<span style="color:#75715e">#   should have a `CELERY_` prefix.</span>
app<span style="color:#f92672">.</span>config_from_object(<span style="color:#e6db74">&#39;django.conf:settings&#39;</span>, namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;CELERY&#39;</span>)

<span style="color:#75715e"># Load task modules from all registered Django app configs.</span>
app<span style="color:#f92672">.</span>autodiscover_tasks()


<span style="color:#a6e22e">@app.task</span>(bind<span style="color:#f92672">=</span>True)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">debug_task</span>(self):
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Request: {0!r}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>request))
</code></pre></td></tr></table>
</div>
</div><pre><code>celery -A django_celery_example worker --pool=solo -l info
</code></pre><p>可以用django shell測試</p>
<pre><code>$ python manage.py shell
</code></pre><p>可以用sync的方式直接執行django_celery_example/celery.py當初裡面的debug_task</p>
<pre><code>&gt;&gt;&gt; from django_celery_example.celery import debug_task
&gt;&gt;&gt; debug_task()
Request: &lt;Context: {'args': (), 'kwargs': {}}&gt;
</code></pre><p>也可以使用async方式執行，只要使用delay這個method，並使用TaskResult這個model來看結果</p>
<pre><code>&gt;&gt;&gt; debug_task.delay()
&lt;AsyncResult: d988824b-5613-4f2d-8034-e3eb69a43fd7&gt;
&gt;&gt;&gt; from django_celery_results.models import TaskResult
&gt;&gt;&gt; TaskResults.objects.all()
&lt;QuerySet [&lt;TaskResult: &lt;Task: d988824b-5613-4f2d-8034-e3eb69a43fd7 (SUCCESS)&gt;&gt;]&gt;
</code></pre><p>而celery的stdout也會有相應的info</p>
<pre><code>[2020-07-22 14:12:01,565: INFO/MainProcess] Received task: django_celery_example.celery.debug_task[d988824b-5613-4f2d-8034-e3eb69a43fd7]
[2020-07-22 14:12:01,566: WARNING/MainProcess] Request: &lt;Context: {'lang': 'py', 'task': 'django_celery_example.celery.debug_task', 'id': 'd988824b-5613-4f2d-8034-e3eb69a43fd7', 'shadow': None, 'eta': None, 'ex
pires': None, 'group': None, 'retries': 0, 'timelimit': [None, None], 'root_id': 'd988824b-5613-4f2d-8034-e3eb69a43fd7', 'parent_id': None, 'argsrepr': '()', 'kwargsrepr': '{}', 'origin': 'gen10892@ABRACADABRA'
, 'reply_to': '57a2696a-9b60-32f2-8cbc-66ec2fb60cea', 'correlation_id': 'd988824b-5613-4f2d-8034-e3eb69a43fd7', 'hostname': 'celery@ABRACADABRA', 'delivery_info': {'exchange': '', 'routing_key': 'celery', 'prio
rity': 0, 'redelivered': False}, 'args': [], 'kwargs': {}, 'is_eager': False, 'callbacks': None, 'errbacks': None, 'chain': None, 'chord': None, 'called_directly': False, '_protected': 1}&gt;
[2020-07-22 14:12:01,587: INFO/MainProcess] Task django_celery_example.celery.debug_task[d988824b-5613-4f2d-8034-e3eb69a43fd7] succeeded in 0.01599999999962165s: None
</code></pre><p>這樣就能確定我們的task queue在正常運作了</p>
<p>接下來要在自己的app內登錄task，首先建立app</p>
<pre><code>$ python manage.py startapp demoapp
</code></pre><p>加進settings.py</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_celery_example/settings.py" data-lang=":django_celery_example/settings.py">INSTALLED_APPS <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;django.contrib.admin&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.auth&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.contenttypes&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.sessions&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.messages&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.staticfiles&#39;</span>,
    <span style="color:#e6db74">&#39;django_celery_results&#39;</span>,
<span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#39;demoapp&#39;</span>,
</span>]
</code></pre></td></tr></table>
</div>
</div><p>一樣在celery.py加上剛才建立的app</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_celery_example/celery.py" data-lang=":django_celery_example/celery.py">app<span style="color:#f92672">.</span>config_from_object(<span style="color:#e6db74">&#39;django.conf:settings&#39;</span>, namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;CELERY&#39;</span>)

<span style="color:#75715e"># Load task modules from all registered Django app configs.</span>
<span style="display:block;width:100%;background-color:#3c3d38">app<span style="color:#f92672">.</span>autodiscover_tasks([<span style="color:#e6db74">&#39;demoapp&#39;</span>])
</span>
</code></pre></td></tr></table>
</div>
</div><p>在__init__.py增加以下內容，這樣才會讀取加上@shared_task這個decotator的task</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_celery_example/__init__.py" data-lang=":django_celery_example/__init__.py"><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> absolute_import, unicode_literals
</span><span style="display:block;width:100%;background-color:#3c3d38">
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"># This will make sure the app is always imported when</span>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"># Django starts so that shared_task will use this app.</span>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#f92672">from</span> .celery <span style="color:#f92672">import</span> app <span style="color:#66d9ef">as</span> celery_app
</span><span style="display:block;width:100%;background-color:#3c3d38">
</span><span style="display:block;width:100%;background-color:#3c3d38">__all__ <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;celery_app&#39;</span>,)
</span></code></pre></td></tr></table>
</div>
</div><p>接下來建立task，先偷懶不使用model</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:demoapp/tasks.py" data-lang=":demoapp/tasks.py"><span style="color:#75715e"># Create your tasks here</span>
<span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> absolute_import, unicode_literals

<span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> shared_task


<span style="color:#a6e22e">@shared_task</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x, y):
    <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y


<span style="color:#a6e22e">@shared_task</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mul</span>(x, y):
    <span style="color:#66d9ef">return</span> x <span style="color:#f92672">*</span> y


<span style="color:#a6e22e">@shared_task</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">xsum</span>(numbers):
    <span style="color:#66d9ef">return</span> sum(numbers)
</code></pre></td></tr></table>
</div>
</div><p>再啟動celery，就會發現多出不同的東西了</p>
<pre><code>$ celery -A django_celery_example worker --pool=solo -l info
...
[tasks]
  . demoapp.tasks.add
  . demoapp.tasks.mul
  . demoapp.tasks.xsum
  . django_celery_example.celery.debug_task

...
</code></pre><p>剛才的task已經進來了，接下來就能用shell測試</p>
<pre><code>&gt;&gt;&gt; from demoapp import tasks
&gt;&gt;&gt; tasks.add.delay(1, 1)
&lt;AsyncResult: 9729c417-9fb1-4868-a884-eeeea4faa125&gt;
&gt;&gt;&gt; tasks.mul.delay(9, 9)
&lt;AsyncResult: 1ac747d8-bff1-46ef-8b0b-0efdeb1f925c&gt;
&gt;&gt;&gt; from django_celery_results.models import TaskResult
&gt;&gt;&gt; TaskResult.objects.all()
&lt;QuerySet [&lt;TaskResult: &lt;Task: 1ac747d8-bff1-46ef-8b0b-0efdeb1f925c (SUCCESS)&gt;&gt;, &lt;TaskResult: &lt;Task: 9729c417-9fb1-4868-a884-eeeea4faa125 (SUCCESS)&gt;&gt;]&gt;
</code></pre><p>也能很簡單的取出結果</p>
<pre><code>&gt;&gt;&gt; TaskResult.objects.get(task_id='1ac747d8-bff1-46ef-8b0b-0efdeb1f925c').result
'81'
</code></pre><p>完</p>


<v-card class="mt-5 content">
  <v-card-text>
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mikanmimi" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </v-card-text>
</v-card>
