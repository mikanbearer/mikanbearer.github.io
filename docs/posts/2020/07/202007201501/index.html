<p>承之前的範例，這次要用JSON Web Token驗證，並加上Cross-Origin Resource Sharing</p>
<p>code放在一樣放在GitHub上
<a href="https://github.com/mikanbearer/django_rest_example"><a href="https://github.com/mikanbearer/django_rest_example">https://github.com/mikanbearer/django_rest_example</a></a></p>
<p>環境大概是以下這樣</p>
<pre><code>$ python --version
Python 3.8.4
$ pip list
...
Django                  3.0
django-cors-headers     3.2.1
djangorestframework     3.11.0
djangorestframework-jwt 1.11.0

</code></pre><p>修改settings.py</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_rest_example/settings.py" data-lang=":django_rest_example/settings.py">INSTALLED_APPS <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;django.contrib.admin&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.auth&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.contenttypes&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.sessions&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.messages&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.staticfiles&#39;</span>,
    <span style="color:#e6db74">&#39;rest_framework&#39;</span>,
<span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#39;corsheaders&#39;</span>, <span style="color:#75715e"># 追加</span>
</span>    <span style="color:#e6db74">&#39;api&#39;</span>,
]
</code></pre></td></tr></table>
</div>
</div><p>Middleware</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_rest_example/settings.py" data-lang=":django_rest_example/settings.py">MIDDLEWARE <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;django.middleware.security.SecurityMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.middleware.common.CommonMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span>,
    <span style="color:#e6db74">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span>,
<span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#39;corsheaders.middleware.CorsMiddleware&#39;</span>,
</span>]
</code></pre></td></tr></table>
</div>
</div><p>白名單</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_rest_example/settings.py" data-lang=":django_rest_example/settings.py"><span style="display:block;width:100%;background-color:#3c3d38">CORS_ORIGIN_WHITELIST <span style="color:#f92672">=</span> [
</span><span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#34;http://localhost:8080&#34;</span>,
</span><span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#34;http://127.0.0.1:9000&#34;</span>
</span><span style="display:block;width:100%;background-color:#3c3d38">]
</span></code></pre></td></tr></table>
</div>
</div><p>JWT設定</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_rest_example/settings.py" data-lang=":django_rest_example/settings.py">REST_FRAMEWORK <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;DEFAULT_PAGINATION_CLASS&#39;</span>: <span style="color:#e6db74">&#39;rest_framework.pagination.PageNumberPagination&#39;</span>,
    <span style="color:#e6db74">&#39;PAGE_SIZE&#39;</span>: <span style="color:#ae81ff">10</span>,
<span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span>: (
</span><span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#e6db74">&#39;rest_framework.permissions.IsAuthenticated&#39;</span>,
</span><span style="display:block;width:100%;background-color:#3c3d38">    ),
</span><span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span>: (
</span><span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#e6db74">&#39;rest_framework_jwt.authentication.JSONWebTokenAuthentication&#39;</span>,
</span><span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#e6db74">&#39;rest_framework.authentication.SessionAuthentication&#39;</span>,
</span><span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#e6db74">&#39;rest_framework.authentication.BasicAuthentication&#39;</span>,
</span><span style="display:block;width:100%;background-color:#3c3d38">    ),
</span>}
</code></pre></td></tr></table>
</div>
</div><p>追加以下</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:api/urls.py" data-lang=":api/urls.py"><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> include, path
<span style="color:#f92672">from</span> rest_framework <span style="color:#f92672">import</span> routers
<span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#f92672">from</span> rest_framework_jwt.views <span style="color:#f92672">import</span> obtain_jwt_token, verify_jwt_token
</span><span style="color:#f92672">from</span> .views <span style="color:#f92672">import</span> LinkmanViewSet

router <span style="color:#f92672">=</span> routers<span style="color:#f92672">.</span>DefaultRouter()
router<span style="color:#f92672">.</span>register(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;linkman&#39;</span>, LinkmanViewSet)

urlpatterns <span style="color:#f92672">=</span> [
    path(<span style="color:#e6db74">&#39;&#39;</span>, include(router<span style="color:#f92672">.</span>urls)),
    path(<span style="color:#e6db74">&#39;api-auth/&#39;</span>, include(<span style="color:#e6db74">&#39;rest_framework.urls&#39;</span>)),
<span style="display:block;width:100%;background-color:#3c3d38">    path(<span style="color:#e6db74">&#39;api-token-auth/&#39;</span>, obtain_jwt_token),
</span><span style="display:block;width:100%;background-color:#3c3d38">    path(<span style="color:#e6db74">&#39;api-token-verify/&#39;</span>, verify_jwt_token),
</span>]
</code></pre></td></tr></table>
</div>
</div><p>使用JWT驗證</p>
<pre><code>$ curl http://127.0.0.1:8000/api/
{&quot;detail&quot;:&quot;Authentication credentials were not provided.&quot;}

$ curl http://127.0.0.1:8000/api/api-token-auth/ -X POST -d &quot;username=admin&amp;password=123&quot;
{&quot;token&quot;:&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6InphcSIsImV4cCI6MTU5NTIzMTA1MiwiZW1haWwiOiJxcUBxcS5xcSJ9.JeifIXkcpy7Koui1ezNMJDACJL1pyE_U0faaBBGeN8o&quot;}

$ curl http://127.0.0.1:8000/api/ -H &quot;Authorization: JWT eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6InphcSIsImV4cCI6MTU5NTIzMTA1MiwiZW1haWwiOiJxcUBxcS5xcSJ9.JeifIXkcpy7Koui1ezNMJDACJL1pyE_U0faaBBGeN8o&quot;
{&quot;linkman&quot;:&quot;http://127.0.0.1:8000/api/linkman/&quot;}
</code></pre><p>測試CORS</p>
<pre><code>$ curl http://127.0.0.1:8000/api/ 
    \-I -X OPTIONS 
    \-H &quot;Origin: http://127.0.0.1:8000&quot; 
    \-H &quot;Access-Control-Request-Method: GET&quot;
HTTP/1.1 200 OK
Date: Mon, 20 Jul 2020 08:53:16 GMT
Server: WSGIServer/0.2 CPython/3.6.8
Content-Type: text/html; charset=utf-8
Content-Length: 0
Vary: Origin
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
</code></pre><p>Origin和白名單一致會出現allow的資訊</p>
<pre><code class="language-{hl_lines=["11-13"]}" data-lang="{hl_lines=["11-13"]}">$ curl http://127.0.0.1:8000/api/ 
    \-I -X OPTIONS 
    \-H &quot;Origin: http://127.0.0.1:9000&quot; 
    \-H &quot;Access-Control-Request-Method: GET&quot;
HTTP/1.1 200 OK
Date: Mon, 20 Jul 2020 08:53:23 GMT
Server: WSGIServer/0.2 CPython/3.6.8
Content-Type: text/html; charset=utf-8
Content-Length: 0
Vary: Origin
Access-Control-Allow-Origin: http://127.0.0.1:9000
Access-Control-Allow-Headers: accept, accept-encoding, authorization, content-type, dnt, origin, user-agent, x-csrftoken, x-requested-with
Access-Control-Allow-Methods: DELETE, GET, OPTIONS, PATCH, POST, PUT
Access-Control-Max-Age: 86400
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
</code></pre>


<v-card class="mt-5 content">
  <v-card-text>
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mikanmimi" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </v-card-text>
</v-card>
