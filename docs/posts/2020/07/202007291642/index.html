<p>雖然docker-compose真的很方便，為了一鍵部屬些東西，還是爬一下文，避免處處碰壁…</p>
<p>這次使用以下兩篇舊文的範例來練習</p>
<p><a href="https://mikanbearer.github.io/myblog/posts/202007262314/">使用製作Vue.js + Vuetify製作SPA登入畫面</a></p>
<p><a href="https://mikanbearer.github.io/myblog/posts/202007201501/">使用Django REST framework超高速部屬RESTful API (2)</a></p>
<p>練習中使用compose file來部屬，所以建立兩個container，</p>
<p><strong>第一個問題來了</strong>
既然是SPA，在不使用localhost的情況，client要怎麼知道API的位置在哪呢？</p>
<p><strong>讓兩個IP相同就好啦</strong></p>
<p>只要像以下連線方式就可以了：
client → nginx web server → django wsgi</p>
<p>嗯…一整串，這樣的意思就是讓nginx在同一個server上提供靜態檔案及wsgi，</p>
<p><strong>※本範例因為使用同一個port，所以不會CORS的問題，故Nginx上並沒有設定相關的header</strong></p>
<p>首先要把front-end弄出來，靠的是webpack來編譯</p>
<pre><code>npm run build
</code></pre><p>會產生一個叫做dist的目錄，編譯好的東西預設都在這裡</p>
<pre><code>dist
  │  favicon.ico
  │  index.html
  │
  ├─css
  │      chunk-vendors.69d077a6.css
  │
  └─js
          app.7215ebfd.js
          app.7215ebfd.js.map
          chunk-vendors.7993b17d.js
          chunk-vendors.7993b17d.js.map
</code></pre><p>然後做一個名為demo的目錄，把東西都扔進來</p>
<pre><code>demo
│  docker-compose.yml
│
├─api ★ 新增
│  │  Dockerfile ★ 新增
│  │  requirements.txt ★ 新增
│  │  usgsi.ini ★ 新增
│  │
│  └─django_rest_example ★ 移動自API的Django Project
│      │  db.sqlite3
│      │  manage.py
│      │
│      ├─api
│      │  │  ...
|      |
│      └─django_rest_example
│          │  ...
│
├─nginx ★ 新增
│      default.conf ★新增
│
└─web ★ 移動至dist，改名web方便辨識
    │  favicon.ico
    │  index.html
    │
    ├─css
    │      chunk-vendors.69d077a6.css
    │
    └─js
            app.7215ebfd.js
            app.7215ebfd.js.map
            chunk-vendors.7993b17d.js
            chunk-vendors.7993b17d.js.map

</code></pre><p>接下來是重點的docker-compose file，因為api的container會需要下載一些package，所以額外做成一個image會比較方便，
而web server的container就沒有這樣的需求，所以精簡就好，照一開始的規劃，
web server要使用tcp socket連到api，所以兩者使用一個docker network來通訊</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:docker-compose.yml" data-lang=":docker-compose.yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">api</span>:
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">./api</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;8000:8000&#34;</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">./api:/api</span>
    <span style="color:#f92672">networks</span>:
      <span style="color:#f92672">backend</span>:
        <span style="color:#f92672">ipv4_address</span>: <span style="color:#ae81ff">172.16.238.11</span>
    <span style="color:#f92672">deploy</span>:
      <span style="color:#f92672">restart_policy</span>:
        <span style="color:#f92672">condition</span>: <span style="color:#66d9ef">on</span>-<span style="color:#ae81ff">failure</span>
    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">uwsgi --ini uwsgi.ini</span>
  <span style="color:#f92672">web</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.19.1</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;80:80&#34;</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">./web:/usr/share/nginx/html</span>
      - <span style="color:#ae81ff">./nginx:/etc/nginx/conf.d</span>
    <span style="color:#f92672">networks</span>:
      <span style="color:#f92672">backend</span>:
        <span style="color:#f92672">ipv4_address</span>: <span style="color:#ae81ff">172.16.238.10</span>
    <span style="color:#f92672">deploy</span>:
      <span style="color:#f92672">restart_policy</span>:
        <span style="color:#f92672">condition</span>: <span style="color:#66d9ef">on</span>-<span style="color:#ae81ff">failure</span>
<span style="color:#f92672">networks</span>:
  <span style="color:#f92672">backend</span>: 
      <span style="color:#f92672">ipam</span>:
        <span style="color:#f92672">driver</span>: <span style="color:#ae81ff">default</span>
        <span style="color:#f92672">config</span>:
          - <span style="color:#f92672">subnet</span>: <span style="color:#e6db74">&#34;172.16.238.0/24&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Dockerfile如下，使用python 3.8.4的image</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:api/Dockerfile" data-lang=":api/Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.8.4</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir -p /api<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /api</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> requirements.txt .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install -r requirements.txt<span style="color:#960050;background-color:#1e0010">
</span></code></pre></td></tr></table>
</div>
</div><p>必要的幾個包</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-requirements.txt" data-lang="requirements.txt">Django == 3.0
django-cors-headers == 3.2.1
djangorestframework == 3.11.0
djangorestframework-jwt == 1.11.0
uWSGI == 2.0.19.1
</code></pre></div><p>uWSGI的設定可以精簡一點</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:api/uwsgi.ini" data-lang=":api/uwsgi.ini"><span style="color:#66d9ef">[uwsgi]</span>

<span style="color:#a6e22e">chdir</span>           <span style="color:#f92672">=</span> <span style="color:#e6db74">/api/django_rest_example</span>
<span style="color:#a6e22e">module</span>          <span style="color:#f92672">=</span> <span style="color:#e6db74">django_rest_example.wsgi</span>
<span style="color:#a6e22e">master</span>          <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
<span style="color:#a6e22e">processes</span>       <span style="color:#f92672">=</span> <span style="color:#e6db74">2</span>
<span style="color:#a6e22e">socket</span>          <span style="color:#f92672">=</span> <span style="color:#e6db74">172.16.238.11:8000 </span>
<span style="color:#a6e22e">vacuum</span>          <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</code></pre></td></tr></table>
</div>
</div><p>nginx用的conf，由location /api來和uWSGI通訊，使用tcp socket</p>
<pre><code class="language-:nginx/default.conf" data-lang=":nginx/default.conf">server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    location / {
        root   /usr/share/nginx/html;
        index  index.html;
    }

    location /api {
        uwsgi_pass 172.16.238.11:8000;
        include uwsgi_params;
    }
}
</code></pre><p>下接來只要以下指令就部屬完成了</p>
<pre><code>demo# docker-compose up
</code></pre>