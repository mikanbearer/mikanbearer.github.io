



    
        
    




{
  "result": {
    "content": "\u003cp\u003e第一篇挫折問題紀錄，各種鬼打牆…\n原本想在EVE-NG上做個簡單的LAB，沒想到問題還真不少…\u003c/p\u003e\n\u003cp\u003e首先使用的是官網下載的EVE Community Edition 2.0.3-110\u003c/p\u003e\n\u003cp\u003evEOS則是網路上撿來，並且已經按照\u003ca href=\"https://www.eve-ng.net/index.php/documentation/howtos/howto-add-arista-veos/\"\u003e這裡\u003c/a\u003e的方法轉換成qcow2的image，才剛試就馬上就卡住了…\u003c/p\u003e\n\u003cp\u003econsole卡在以下畫面\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eAboot 2.1.0-2121970\r\n\r\n\r\nPress Control-C now to enter Aboot shell\r\nBooting flash:/vEOS-lab.swi\r\n[    9.072566] Starting new kernel\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e看起來Aboot正常，但是到了kernel開機就卡住\u003c/p\u003e\n\u003cp\u003e後來發現EVE上有output呢？\n\u003cimg src=\"1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e看起來就是虛擬化失敗，但總覺得哪裡有點古怪，先去看log\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@eve-ng:~# tail /var/log/syslog \r\nJul 24 22:07:52 eve-ng systemd-udevd[5789]: Could not generate persistent MAC address for vunl0_1_1: No such file or directory\r\nJul 24 22:07:52 eve-ng systemd-udevd[5880]: Could not generate persistent MAC address for vunl0_1_2: No such file or directory\r\nJul 24 22:07:52 eve-ng systemd-udevd[5752]: Could not generate persistent MAC address for vunl0_1_3: No such file or directory\r\nJul 24 22:07:52 eve-ng systemd-udevd[5789]: Could not generate persistent MAC address for vunl0_1_4: No such file or directory\r\nJul 24 22:07:52 eve-ng systemd-udevd[5888]: Could not generate persistent MAC address for vunl0_1_5: No such file or directory\r\nJul 24 22:07:52 eve-ng systemd-udevd[6098]: Could not generate persistent MAC address for vunl0_1_6: No such file or directory\r\nJul 24 22:07:52 eve-ng systemd-udevd[5880]: Could not generate persistent MAC address for vunl0_1_7: No such file or directory\r\nJul 24 22:07:52 eve-ng systemd-udevd[5752]: Could not generate persistent MAC address for vunl0_1_8: No such file or directory\r\nJul 24 22:08:02 eve-ng kernel: [  686.996310] kvm [6431]: vcpu0, guest rIP: 0xffffffff81686dc8 disabled perfctr wrmsr: 0xc1 data 0xabcd\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cstrong\u003e全掛…\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e而且報錯的是kernel，這就沒那麼好解決了…\u003c/p\u003e\n\u003cp\u003e無奈之下，只好跟朋友要了舊版2.0.3-92\u003c/p\u003e\n\u003cp\u003e一開機\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eBooting flash:/vEOS-lab.swi\r\n[    6.428401] Starting new kernel\r\nSwitching rootfs\r\n\r\nWelcome to Arista Networks EOS 4.15.5M\r\nMounting filesystems:  [  OK  ]\r\nStarting udev: [  OK  ]\r\nSetting hostname localhost:  [  OK  ]\r\nEntering non-interactive startup\r\nStarting TimeAgent: Cannot find immortalize pid [FAILED]\r\nStarting ProcMgr: [  OK  ]\r\nStarting EOS initialization stage 1: [   11.005777] NMI watchdog: failed to be enabled on some cpus\r\n[  OK  ]\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cstrong\u003e蛤？可以用？？\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e搞到頭都疼了，比較一下kernel的版本\n這次嘗試不能用的2.0.3-110\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@eve-ng:~# uname -r\r\n4.20.17-eve-ng-ukms+\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e意外可以用的2.0.3-92\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@eve-ng:~# uname -r\r\n4.9.40-eve-ng-ukms-2+\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e兩者究竟差在哪呢？\u003c/p\u003e\n\u003cp\u003e\u0026mdash;\u0026mdash;\u0026mdash;2020/07/25補\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u003c/p\u003e\n\u003cp\u003e不甘心又查了一次，這次從虛擬化開始找起，首先是QEMU的版本\u003c/p\u003e\n\u003cp\u003e能用的\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"old.PNG\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e不能用的\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"new.PNG\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e看來QEMU版本不一樣呢…\u003c/strong\u003e\n　　\n那就來試試看相同的版本，首先確定版本號\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@eve-ng:~# /opt/qemu-2.4.0/bin/qemu-system-x86_64 --version\r\n\r\n(process:18019): GLib-WARNING **: /build/glib2.0-xkQkqE/glib2.0-2.48.2/./glib/gmem.c:483: custom memory allocation vtable not supported\r\nQEMU emulator version 2.4.0, Copyright (c) 2003-2008 Fabrice Bellard\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e使用ps -aux來找出失敗的command\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@eve-ng:~# ps -aux | grep qemu\r\nroot      5296 81.5  3.5 2958708 289036 ?      Sl   11:58   0:21 /opt/qemu-4.1.0/bin/qemu-system-x86_64 -nographic -device e1000,netdev=net0,mac=50:00:00:01:00:00 -netdev tap,id=net0,ifname=vunl0_1_0,script=no -device e1000,netdev=net1,mac=50:00:00:01:00:01 -netdev tap,id=net1,ifname=vunl0_1_1,script=no -device e1000,netdev=net2,mac=50:00:00:01:00:02 -netdev tap,id=net2,ifname=vunl0_1_2,script=no -device e1000,netdev=net3,mac=50:00:00:01:00:03 -netdev tap,id=net3,ifname=vunl0_1_3,script=no -device e1000,netdev=net4,mac=50:00:00:01:00:04 -netdev tap,id=net4,ifname=vunl0_1_4,script=no -device e1000,netdev=net5,mac=50:00:00:01:00:05 -netdev tap,id=net5,ifname=vunl0_1_5,script=no -device e1000,netdev=net6,mac=50:00:00:01:00:06 -netdev tap,id=net6,ifname=vunl0_1_6,script=no -device e1000,netdev=net7,mac=50:00:00:01:00:07 -netdev tap,id=net7,ifname=vunl0_1_7,script=no -device e1000,netdev=net8,mac=50:00:00:01:00:08 -netdev tap,id=net8,ifname=vunl0_1_8,script=no -smp 1 -m 2048 -name vEOS -uuid 3308871b-8b59-4bc5-ae4e-4f2a5d478676 -cdrom /opt/unetlab/addons/qemu/veos-4.15.0F/cdrom.iso -hda hda.qcow2 -machine type=pc,accel=kvm -serial mon:stdio -nographic -display none -no-user-config -rtc base=utc -boot order=d\r\nroot      5425  0.0  0.0  16576  2072 pts/0    R+   11:59   0:00 grep --color=auto qemu\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cstrong\u003e有點雜亂…\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e稍微整理一下後，只留下一個interface，且版本改為2.4，所以定版的指令就用這個\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@eve-ng:~# /opt/qemu-2.4.0/bin/qemu-system-x86_64 -nographic -device e1000,netdev=net0,mac=50:00:00:01:00:00 -netdev tap,id=net0,ifname=vunl0_1_0,script=no -smp 1 -m 2048 -name vEOS -uuid 3308871b-8b59-4bc5-ae4e-4f2a5d478676 -cdrom /opt/unetlab/addons/qemu/veos-4.15.0F/cdrom.iso -hda /opt/unetlab/addons/qemu/veos-4.15.0F/hda.qcow2 -machine type=pc,accel=kvm -serial mon:stdio -nographic -display none -no-user-config -rtc base=utc -boot order=d\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cstrong\u003e還是失敗\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e所以並不是QEMU版本的問題，那麼就只好從option著手了\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@eve-ng:/opt/unetlab/addons/qemu/veos-4.15.0F# /opt/qemu-4.1.0/bin/qemu-system-x86_64 -nographic -cdrom cdrom.iso -boot d -hda hda.qcow2 -m 1024\r\n\u003c/code\u003e\u003c/pre\u003e\u003cpre\u003e\u003ccode\u003eAboot 2.1.0-2121970\r\n\r\n\r\nPress Control-C now to enter Aboot shell\r\nBooting flash:/vEOS-lab.swi\r\n[    6.089384] Starting new kernel\r\nSwitching rootfs\r\n\r\nWelcome to Arista Networks EOS 4.15.5M\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cstrong\u003e成功開機了\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e所以是option的問題，在經過數次比對後，發現是-machine這個option有問題…\u003c/p\u003e\n\u003cp\u003e-machine type=pc,accel=kvm是行不通的，但是拿掉accel這個porp就可以成功開機，像是以下範例：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@eve-ng:~# /opt/qemu-4.1.0/bin/qemu-system-x86_64 -nographic -device e1000,netdev=net0,mac=50:00:00:01:00:00 -netdev tap,id=net0,ifname=vunl0_1_0,script=no -smp 1 -m 2048 -name vEOS -uuid 3308871b-8b59-4bc5-ae4e-4f2a5d478676 -cdrom /opt/unetlab/addons/qemu/veos-4.15.0F/cdrom.iso -hda /opt/unetlab/addons/qemu/veos-4.15.0F/hda.qcow2 -machine type=pc -serial mon:stdio -nographic -display none -no-user-config -rtc base=utc -boot order=d\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e問題是這樣運行速度感覺特別慢…\n\u0026mdash;\u0026mdash;\u0026mdash;2020/07/26補\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\n越想越不甘心，回頭看了下能用的2.0.3-92，\u003cstrong\u003e意外發現option的template長不一樣！\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e2.0.3-92\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"old1.PNG\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e2.0.3-110\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"new1.PNG\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e看來在type=pc的情況下，加上accel這個prop會讓vEOS啟動失敗…\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e測試之後，以下的指令是可以用的\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@eve-ng:~# /opt/qemu-4.1.0/bin/qemu-system-x86_64 -nographic \\\r\n-device e1000,netdev=net0,mac=50:00:00:01:00:00 \\\r\n-netdev tap,id=net0,ifname=vunl0_1_0,script=no \\\r\n-smp 1 -m 2048 -name vEOS -uuid 3308871b-8b59-4bc5-ae4e-4f2a5d478676 \\\r\n-cdrom /opt/unetlab/addons/qemu/veos-4.15.0F/cdrom.iso \\\r\n-hda /opt/unetlab/addons/qemu/veos-4.15.0F/hda.qcow2 \\\r\n-machine type=pc-1.0,accel=kvm -serial mon:stdio -nographic -display none -no-user-config -rtc base=utc -boot order=d\r\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e所以不需要卡卡了，之後再換個vEOS的版本試試看\u003c/p\u003e",
    "kind": "page",
    "params": {
      "categories": [
        "Arista"
      ],
      "date": "2020-07-24T15:54:30+08:00",
      "draft": false,
      "iscjklanguage": true,
      "lastmod": "2020-07-24T15:54:30+08:00",
      "publishdate": "2020-07-24T15:54:30+08:00",
      "tags": [
        "EVE-NG"
      ],
      "title": "在EVE-NG上部屬vEOS LAB"
    },
    "permalink": "https://mikanbearer.github.io/posts/202007241554/index.json",
    "type": "posts",
    "wordcount": 1355
  }
}