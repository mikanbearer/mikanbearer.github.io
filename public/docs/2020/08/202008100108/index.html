<p>製作一個網頁聊天室，首先要讓服務端和用戶端實現異步通訊，而服務端要包含一個訊息貯列，讓所有符合條件的用戶端都能收到相應的訊息，
剛好可作為Message Queue及Web Socket的練習。</p>
<p>本篇Message Queue使用RabbitMQ，Framework使用Django，並且由Channels來實現Web Socket</p>
<p>在Message Queue中，會有訊息的產生及消費，而在RabbitMQ中，主要就以下幾種：</p>
<ul>
<li>Producer：將訊息丟到Exchange</li>
<li>Exchange：將訊息分配到對應的Queue</li>
<li>Queue：存放訊息讓Consumer取用</li>
<li>Consumer：從Queue取得訊息<br>
<br></br></li>
</ul>
<p>加上Web Socket的話，架構會向下圖所示：</p>
<p><img src="1.png" alt="">
<br></br></p>
<p>而這次Web Server是Django，而實現WebSocket的Channels會同時是Producer及Consumer<br>
<strong>準備開始動工！</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:rabbitmq/docker-compose.yml" data-lang=":rabbitmq/docker-compose.yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>

<span style="color:#f92672">services</span>:
  <span style="color:#f92672">my-queue</span>:
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">rabbitmq</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">rabbitmq:3.7.4-management</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#39;5672:5672&#39;</span>
      - <span style="color:#e6db74">&#39;15672:15672&#39;</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">rabbitmq-data:/var/lib/rabbitmq</span>

<span style="color:#f92672">volumes</span>:
    <span style="color:#f92672">rabbitmq-data</span>:
</code></pre></td></tr></table>
</div>
</div><p><br></br>
輸入指令</p>
<pre><code># docker-compose up
</code></pre><p><br></br>
建立一個vhost備用</p>
<pre><code>$ curl -i -u guest:guest -H &quot;content-type:application/json&quot;  \
    -XPUT http://localhost:15672/api/vhosts/asgi
</code></pre><p>到這裡RabbitMQ就準備完成了，接下來是Channels的部分
<br></br>
建立requirtments.txt供pip使用</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:requirtments.txt" data-lang=":requirtments.txt">django == 3.0
channels == 2.4.0
channels_rabbitmq == 1.2.1
</code></pre></td></tr></table>
</div>
</div><p>安裝上列的幾個包</p>
<pre><code>$ pip install -r requirements.txt
</code></pre><p>還有django的指令</p>
<pre><code>$ django-admin startproject django-channels-example
$ cd django_channels_example
$ python manage.py startapp
</code></pre><p><br></br>
修改settings.py，加上channels及自己的app</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_channels_example/settings.py" data-lang=":django_channels_example/settings.py">INSTALLED_APPS <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;django.contrib.admin&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.auth&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.contenttypes&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.sessions&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.messages&#39;</span>,
    <span style="color:#e6db74">&#39;django.contrib.staticfiles&#39;</span>,
<span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#39;channels&#39;</span>,
</span><span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#39;app&#39;</span>,
</span>]
</code></pre></td></tr></table>
</div>
</div><p><br></br>
加上Channels的設定，host指向剛才建立的vhost</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Channels</span>
<span style="display:block;width:100%;background-color:#3c3d38">ASGI_APPLICATION <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;django_channels_example.routing.application&#39;</span>
</span><span style="display:block;width:100%;background-color:#3c3d38">
</span><span style="display:block;width:100%;background-color:#3c3d38">CHANNEL_LAYERS <span style="color:#f92672">=</span> {
</span><span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#e6db74">&#34;default&#34;</span>: {
</span><span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#e6db74">&#34;BACKEND&#34;</span>: <span style="color:#e6db74">&#34;channels_rabbitmq.core.RabbitmqChannelLayer&#34;</span>,
</span><span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#e6db74">&#34;CONFIG&#34;</span>: {
</span><span style="display:block;width:100%;background-color:#3c3d38">            <span style="color:#e6db74">&#34;host&#34;</span>: <span style="color:#e6db74">&#34;amqp://guest:guest@127.0.0.1/asgi&#34;</span>,
</span><span style="display:block;width:100%;background-color:#3c3d38">        },
</span><span style="display:block;width:100%;background-color:#3c3d38">    },
</span><span style="display:block;width:100%;background-color:#3c3d38">}
</span></code></pre></td></tr></table>
</div>
</div><p><br></br>
接下來大致參照Channels的<a href="https://channels.readthedocs.io/en/latest/tutorial/part_2.html">Tutorial</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:app/consumers.py" data-lang=":app/consumers.py"><span style="color:#f92672">import</span> json
<span style="color:#f92672">from</span> channels.generic.websocket <span style="color:#f92672">import</span> AsyncWebsocketConsumer

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChatConsumer</span>(AsyncWebsocketConsumer):
    async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connect</span>(self):
        self<span style="color:#f92672">.</span>room_name <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>scope[<span style="color:#e6db74">&#39;url_route&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>][<span style="color:#e6db74">&#39;room_name&#39;</span>]
        self<span style="color:#f92672">.</span>room_group_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;chat_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>room_name

        <span style="color:#75715e"># Join room group</span>
        await self<span style="color:#f92672">.</span>channel_layer<span style="color:#f92672">.</span>group_add(
            self<span style="color:#f92672">.</span>room_group_name,
            self<span style="color:#f92672">.</span>channel_name
        )

        await self<span style="color:#f92672">.</span>accept()

    async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">disconnect</span>(self, close_code):
        <span style="color:#75715e"># Leave room group</span>
        await self<span style="color:#f92672">.</span>channel_layer<span style="color:#f92672">.</span>group_discard(
            self<span style="color:#f92672">.</span>room_group_name,
            self<span style="color:#f92672">.</span>channel_name
        )

    <span style="color:#75715e"># Receive message from WebSocket</span>
    async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">receive</span>(self, text_data):
        text_data_json <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(text_data)
        message <span style="color:#f92672">=</span> text_data_json[<span style="color:#e6db74">&#39;message&#39;</span>]

        <span style="color:#75715e"># Send message to room group</span>
        await self<span style="color:#f92672">.</span>channel_layer<span style="color:#f92672">.</span>group_send(
            self<span style="color:#f92672">.</span>room_group_name,
            {
                <span style="color:#e6db74">&#39;type&#39;</span>: <span style="color:#e6db74">&#39;chat_message&#39;</span>,
                <span style="color:#e6db74">&#39;message&#39;</span>: message
            }
        )

    <span style="color:#75715e"># Receive message from room group</span>
    async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">chat_message</span>(self, event):
        message <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#39;message&#39;</span>]

        <span style="color:#75715e"># Send message to WebSocket</span>
        await self<span style="color:#f92672">.</span>send(text_data<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>dumps({
            <span style="color:#e6db74">&#39;message&#39;</span>: message
        }))
</code></pre></td></tr></table>
</div>
</div><p><br></br>
建立app/routing.py,由這裡定義Consumer的Pattern</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:app/routing.py" data-lang=":app/routing.py"><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> re_path
<span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> consumers

websocket_urlpatterns <span style="color:#f92672">=</span> [
    re_path(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;ws/(?P&lt;room_name&gt;\w+)/$&#39;</span>, consumers<span style="color:#f92672">.</span>ChatConsumer),
]
</code></pre></td></tr></table>
</div>
</div><p><br></br>
建立project/routing.py</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_channels_example/routing.py" data-lang=":django_channels_example/routing.py"><span style="color:#f92672">from</span> channels.auth <span style="color:#f92672">import</span> AuthMiddlewareStack
<span style="color:#f92672">from</span> channels.routing <span style="color:#f92672">import</span> ProtocolTypeRouter, URLRouter
<span style="color:#f92672">import</span> app.routing

application <span style="color:#f92672">=</span> ProtocolTypeRouter({
    <span style="color:#e6db74">&#39;websocket&#39;</span>: AuthMiddlewareStack(
        URLRouter(
            app<span style="color:#f92672">.</span>routing<span style="color:#f92672">.</span>websocket_urlpatterns
        )
    ),
})
</code></pre></td></tr></table>
</div>
</div><p><br></br></p>
<p>準備簡易的template與view</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:app/templates/app/room.html" data-lang=":app/templates/app/room.html"><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color:#f92672">html</span>&gt;
&lt;<span style="color:#f92672">head</span>&gt;
    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>/&gt;
    &lt;<span style="color:#f92672">title</span>&gt;Chat Room&lt;/<span style="color:#f92672">title</span>&gt;
&lt;/<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">body</span>&gt;
    &lt;<span style="color:#f92672">textarea</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;chat-log&#34;</span> <span style="color:#a6e22e">cols</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100&#34;</span> <span style="color:#a6e22e">rows</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;20&#34;</span>&gt;&lt;/<span style="color:#f92672">textarea</span>&gt;&lt;<span style="color:#f92672">br</span>&gt;
    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;chat-message-input&#34;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text&#34;</span> <span style="color:#a6e22e">size</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100&#34;</span>&gt;&lt;<span style="color:#f92672">br</span>&gt;
    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;chat-message-submit&#34;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;button&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Send&#34;</span>&gt;
    {{ room_name|json_script:&#34;room-name&#34; }}
    &lt;<span style="color:#f92672">script</span>&gt;
        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">roomName</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#39;room-name&#39;</span>).<span style="color:#a6e22e">textContent</span>);

        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">chatSocket</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebSocket</span>(
            <span style="color:#e6db74">&#39;ws://&#39;</span>
            <span style="color:#f92672">+</span> window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">host</span>
            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/ws/&#39;</span>
            <span style="color:#f92672">+</span> <span style="color:#a6e22e">roomName</span>
            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/&#39;</span>
        );

        <span style="color:#a6e22e">chatSocket</span>.<span style="color:#a6e22e">onmessage</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">e</span>) {
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">data</span>);
            document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#chat-log&#39;</span>).<span style="color:#a6e22e">value</span> <span style="color:#f92672">+=</span> (<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">message</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;\n&#39;</span>);
        };

        <span style="color:#a6e22e">chatSocket</span>.<span style="color:#a6e22e">onclose</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">e</span>) {
            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#39;Chat socket closed unexpectedly&#39;</span>);
        };

        document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#chat-message-input&#39;</span>).<span style="color:#a6e22e">focus</span>();
        document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#chat-message-input&#39;</span>).<span style="color:#a6e22e">onkeyup</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">e</span>) {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">keyCode</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">13</span>) {  <span style="color:#75715e">// enter, return
</span><span style="color:#75715e"></span>                document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#chat-message-submit&#39;</span>).<span style="color:#a6e22e">click</span>();
            }
        };

        document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#chat-message-submit&#39;</span>).<span style="color:#a6e22e">onclick</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">e</span>) {
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">messageInputDom</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#chat-message-input&#39;</span>);
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">message</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">messageInputDom</span>.<span style="color:#a6e22e">value</span>;
            <span style="color:#a6e22e">chatSocket</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
                <span style="color:#e6db74">&#39;message&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">message</span>
            }));
            <span style="color:#a6e22e">messageInputDom</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
        };
    &lt;/<span style="color:#f92672">script</span>&gt;
&lt;/<span style="color:#f92672">body</span>&gt;
&lt;/<span style="color:#f92672">html</span>&gt;
</code></pre></td></tr></table>
</div>
</div><p><br></br></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:app/views.py" data-lang=":app/views.py"><span style="color:#f92672">from</span> django.shortcuts <span style="color:#f92672">import</span> render

<span style="color:#75715e"># Create your views here.</span>
<span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">room</span>(request, room_name):
</span><span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#66d9ef">return</span> render(request, <span style="color:#e6db74">&#39;app/room.html&#39;</span>, {
</span><span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#e6db74">&#39;room_name&#39;</span>: room_name
</span><span style="display:block;width:100%;background-color:#3c3d38">    })
</span></code></pre></td></tr></table>
</div>
</div><p><br></br>
最後建立app/urls.py及修改project/urls.py，就能透過vuew來測試了</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:app/urls.py" data-lang=":app/urls.py"><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path

<span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> views

urlpatterns <span style="color:#f92672">=</span> [
    path(<span style="color:#e6db74">&#39;&lt;str:room_name&gt;/&#39;</span>, views<span style="color:#f92672">.</span>room, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;room&#39;</span>),
]
</code></pre></td></tr></table>
</div>
</div><p><br></br></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:django_channels_example/urls.py" data-lang=":django_channels_example/urls.py"><span style="color:#f92672">from</span> django.contrib <span style="color:#f92672">import</span> admin
<span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path, include
</span>
urlpatterns <span style="color:#f92672">=</span> [
    path(<span style="color:#e6db74">&#39;admin/&#39;</span>, admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>urls),
<span style="display:block;width:100%;background-color:#3c3d38">    path(<span style="color:#e6db74">&#39;&#39;</span>, include(<span style="color:#e6db74">&#39;app.urls&#39;</span>)),
</span>]
</code></pre></td></tr></table>
</div>
</div><p><br></br>
把Server開起來就能測試了</p>
<pre><code>$ python manage.py runserver
</code></pre><p>RabbitMQ會看到Client連上的訊息</p>
<pre><code>rabbitmq    | 2020-08-13 07:32:54.655 [warning] &lt;0.577.0&gt; closing AMQP connection &lt;0.577.0&gt; (192.168.149.1:36675 -&gt; 172.18.0.2:5672, vhost: 'asgi', user: 'guest'):
rabbitmq    | client unexpectedly closed TCP connection
</code></pre><p>前往網址localhost:8000/qq就能透過簡易的Web連上WebSocket</p>
<pre><code>WebSocket CONNECT /ws/qq/ [127.0.0.1:37334]
</code></pre><p>這樣所有連上同個room的用戶端都能收送並共享訊息了</p>
<p>完整版一樣放上GitHub <a href="https://github.com/mikanbearer/django_channels_example">https://github.com/mikanbearer/django_channels_example</a></p>