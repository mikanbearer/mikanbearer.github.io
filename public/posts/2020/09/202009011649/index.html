<p>雖然久仰Ansible大名，但總是停留在紙上談兵的階段，這次就先練習一遍，熟悉點再來自己寫role</p>
<p>參考文件：<a href="https://docs.ansible.com/">https://docs.ansible.com/</a></p>
<p>本次環境用四台VM，分別是</p>
<ul>
<li>Debian 9.7(Controller)：192.168.149.130</li>
<li>Debian 9.7(Target) * 2：192.168.149.131 .133</li>
<li>CentOS 7.7(Ansible Target)：192.168.149.132
<br></br></li>
</ul>
<p>首先來安裝最新版的Ansible</p>
<pre><code># echo 'deb http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main' &gt;&gt; /etc/apt/sources.list
# apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 93C4A3FD7BB9C367
# apt update
# apt install ansible
</code></pre><p><br></br>
確認一下版本</p>
<pre><code>$ ansible --version
ansible 2.9.13
  config file = /etc/ansible/ansible.cfg
  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python2.7/dist-packages/ansible
  executable location = /usr/bin/ansible
  python version = 2.7.13 (default, Sep 26 2018, 18:42:22) [GCC 6.3.0 20170516]
</code></pre><p><br></br>
首先使用ping module試試</p>
<pre><code>$ ansible all -m ping
[WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'
</code></pre><p>會很貼心地說hosts是空的，值得議題的是，implicit的group會有兩種，一個是<code>all</code>，另一個則是<code>ungrouped</code>，兩者皆不會匹配到localhost
<br></br>
那就指定成localhost</p>
<pre><code>$ ansible localhost -m ping
localhost | SUCCESS =&gt; {
    &quot;changed&quot;: false, 
    &quot;ping&quot;: &quot;pong&quot;
}
</code></pre><p>就可以看到ping成功的訊息了
<br></br></p>
<h3 id="設定inventory">設定Inventory</h3>
<hr>
<p><br></br>
接下來就是建立自己的inventory，預設的ansible目錄是這樣</p>
<pre><code>/etc/ansible/
├── ansible.cfg
├── hosts
└── roles
</code></pre><p><br></br>
而這次要修改的就是這個<strong>hosts</strong>，host的格式可使用INI和YAML，而這次練習用了這三個變數</p>
<ul>
<li>ansible_user → 登入帳號</li>
<li>ansible_password → 登入密碼(不使用key的時候採用的)</li>
<li>ansible_python_interpreter → 檢查target的interpreter
INI範例：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-INI" data-lang="INI"><span style="color:#66d9ef">[group1]</span>
<span style="color:#a6e22e">192.168.149.131</span>
<span style="color:#a6e22e">192.168.149.133</span>

<span style="color:#66d9ef">[group1:vars]</span>
<span style="color:#a6e22e">ansible_user</span><span style="color:#f92672">=</span><span style="color:#e6db74">abc</span>
<span style="color:#a6e22e">ansible_password</span><span style="color:#f92672">=</span><span style="color:#e6db74">123</span>
<span style="color:#a6e22e">ansible_python_interpreter</span><span style="color:#f92672">=</span><span style="color:#e6db74">auto_legacy_silent</span>
</code></pre></div><p><br></br>
YAML範例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#66d9ef">all</span>:
  <span style="color:#66d9ef">children</span>:
    <span style="color:#66d9ef">group1</span>:
      <span style="color:#66d9ef">hosts</span>:
        <span style="color:#66d9ef">192.168.149.131</span>:
        <span style="color:#66d9ef">192.168.149.133</span>:
      <span style="color:#66d9ef">vars</span>:
        <span style="color:#66d9ef">ansible_user</span>: abc
        <span style="color:#66d9ef">ansible_password</span>: <span style="color:#ae81ff">123</span>
        <span style="color:#66d9ef">ansible_python_interpreter</span>: auto_legacy_silent
</code></pre></div><p><br></br>
使用YAML的話，最底層必須是all，像以下範例的話，一台host會列為<code>ungrouped</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#66d9ef">all</span>:
  <span style="color:#66d9ef">children</span>:
    <span style="color:#66d9ef">group1</span>:
      <span style="color:#66d9ef">hosts</span>:
        <span style="color:#66d9ef">192.168.149.131</span>:
  <span style="color:#66d9ef">hosts</span>:
    <span style="color:#66d9ef">192.168.149.133</span>:
</code></pre></div><p><br></br>
可以用以下指令來確認inventory</p>
<pre><code>$ ansible-inventory --graph
@all:
  |--@group1:
  |  |--192.168.149.131
  |  |--192.168.149.133
  |--@ungrouped:
</code></pre><p><br></br>
Ansible預設會進行ssh key checking，這裡為了方便先取消掉</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:ansible.cfg" data-lang=":ansible.cfg">
<span style="color:#a6e22e">...</span>
<span style="color:#a6e22e">host_key_checking</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">False</span>
</code></pre></div><p><br></br>
再ping一次就成功了，因為沒有變更，所以changed會是false</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible all -m ping
192.168.149.131 | SUCCESS <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;ansible_facts&#34;</span>: <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;discovered_interpreter_python&#34;</span>: <span style="color:#e6db74">&#34;/usr/bin/python&#34;</span>
    <span style="color:#f92672">}</span>, 
    <span style="color:#e6db74">&#34;changed&#34;</span>: false, 
    <span style="color:#e6db74">&#34;ping&#34;</span>: <span style="color:#e6db74">&#34;pong&#34;</span>
<span style="color:#f92672">}</span>
192.168.149.133 | SUCCESS <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;ansible_facts&#34;</span>: <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;discovered_interpreter_python&#34;</span>: <span style="color:#e6db74">&#34;/usr/bin/python&#34;</span>
    <span style="color:#f92672">}</span>, 
    <span style="color:#e6db74">&#34;changed&#34;</span>: false, 
    <span style="color:#e6db74">&#34;ping&#34;</span>: <span style="color:#e6db74">&#34;pong&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><br></br>
不用-m的話，也能用-a來讓target輸入指令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible group1 -a <span style="color:#e6db74">&#39;/bin/echo &#34;hello&#34;&#39;</span>
192.168.149.133 | CHANGED | rc<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> &gt;&gt;
hello
192.168.149.131 | CHANGED | rc<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> &gt;&gt;
hello
</code></pre></div><p><br></br></p>
<h3 id="使用playbook">使用Playbook</h3>
<hr>
<p><br></br>
首先建立一個yaml檔，可直接指定先前的group，在指定incentory file的情況下，預設會吃ansible/hosts</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:playbook.yml" data-lang=":playbook.yml">
---
- <span style="color:#66d9ef">hosts</span>: group1
</code></pre></div><p><br></br></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml 

PLAY <span style="color:#f92672">[</span>group1<span style="color:#f92672">]</span> ******************************************************************************************************************************************************************************************************************************

TASK <span style="color:#f92672">[</span>Gathering Facts<span style="color:#f92672">]</span> *********************************************************************************************************************************************************************************************************************
ok: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span>
ok: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span>

PLAY RECAP *********************************************************************************************************************************************************************************************************************************
192.168.149.131            : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>   
192.168.149.133            : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  
</code></pre></div><p><br></br>
試著定義task，使用apt module</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:playbook.yml" data-lang=":playbook.yml">
---
- <span style="color:#66d9ef">hosts</span>: group1
  <span style="color:#66d9ef">tasks</span>:
    - <span style="color:#66d9ef">name</span>: install latest python3
      <span style="color:#66d9ef">apt</span>:
        <span style="color:#66d9ef">name</span>: python3
        <span style="color:#66d9ef">state</span>: present
        <span style="color:#66d9ef">update_cache</span>: yes
</code></pre></div><p><br></br>
想當然爾會遇到權限問題</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml

PLAY <span style="color:#f92672">[</span>group1<span style="color:#f92672">]</span> ******************************************************************************************************************************************************************************************************************************

TASK <span style="color:#f92672">[</span>Gathering Facts<span style="color:#f92672">]</span> *********************************************************************************************************************************************************************************************************************
ok: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span>
ok: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>install latest python3<span style="color:#f92672">]</span> ***************************************************************************************************************************************************************************************************************
<span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span>: Updating cache and auto-installing missing dependency: python-apt
fatal: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span>: FAILED! <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;changed&#34;</span>: false, <span style="color:#e6db74">&#34;cmd&#34;</span>: <span style="color:#e6db74">&#34;apt-get update&#34;</span>, <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;E: Could not open lock file /var/lib/apt/lists/lock - open (13: Permission denied)\nE: Unable to lock directory /var/lib/apt/lists/\nW: Problem unlinking the file /var/cache/apt/pkgcache.bin - RemoveCaches (13: Permission denied)\nW: Problem unlinking the file /var/cache/apt/srcpkgcache.bin - RemoveCaches (13: Permission denied)&#34;</span>, <span style="color:#e6db74">&#34;rc&#34;</span>: 100, <span style="color:#e6db74">&#34;stderr&#34;</span>: <span style="color:#e6db74">&#34;E: Could not open lock file /var/lib/apt/lists/lock - open (13: Permission denied)\nE: Unable to lock directory /var/lib/apt/lists/\nW: Problem unlinking the file /var/cache/apt/pkgcache.bin - RemoveCaches (13: Permission denied)\nW: Problem unlinking the file /var/cache/apt/srcpkgcache.bin - RemoveCaches (13: Permission denied)\n&#34;</span>, <span style="color:#e6db74">&#34;stderr_lines&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;E: Could not open lock file /var/lib/apt/lists/lock - open (13: Permission denied)&#34;</span>, <span style="color:#e6db74">&#34;E: Unable to lock directory /var/lib/apt/lists/&#34;</span>, <span style="color:#e6db74">&#34;W: Problem unlinking the file /var/cache/apt/pkgcache.bin - RemoveCaches (13: Permission denied)&#34;</span>, <span style="color:#e6db74">&#34;W: Problem unlinking the file /var/cache/apt/srcpkgcache.bin - RemoveCaches (13: Permission denied)&#34;</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">&#34;stdout&#34;</span>: <span style="color:#e6db74">&#34;Reading package lists...\n&#34;</span>, <span style="color:#e6db74">&#34;stdout_lines&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;Reading package lists...&#34;</span><span style="color:#f92672">]}</span>
fatal: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span>: FAILED! <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;changed&#34;</span>: false, <span style="color:#e6db74">&#34;cmd&#34;</span>: <span style="color:#e6db74">&#34;apt-get update&#34;</span>, <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;E: Could not open lock file /var/lib/apt/lists/lock - open (13: Permission denied)\nE: Unable to lock directory /var/lib/apt/lists/\nW: Problem unlinking the file /var/cache/apt/pkgcache.bin - RemoveCaches (13: Permission denied)\nW: Problem unlinking the file /var/cache/apt/srcpkgcache.bin - RemoveCaches (13: Permission denied)&#34;</span>, <span style="color:#e6db74">&#34;rc&#34;</span>: 100, <span style="color:#e6db74">&#34;stderr&#34;</span>: <span style="color:#e6db74">&#34;E: Could not open lock file /var/lib/apt/lists/lock - open (13: Permission denied)\nE: Unable to lock directory /var/lib/apt/lists/\nW: Problem unlinking the file /var/cache/apt/pkgcache.bin - RemoveCaches (13: Permission denied)\nW: Problem unlinking the file /var/cache/apt/srcpkgcache.bin - RemoveCaches (13: Permission denied)\n&#34;</span>, <span style="color:#e6db74">&#34;stderr_lines&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;E: Could not open lock file /var/lib/apt/lists/lock - open (13: Permission denied)&#34;</span>, <span style="color:#e6db74">&#34;E: Unable to lock directory /var/lib/apt/lists/&#34;</span>, <span style="color:#e6db74">&#34;W: Problem unlinking the file /var/cache/apt/pkgcache.bin - RemoveCaches (13: Permission denied)&#34;</span>, <span style="color:#e6db74">&#34;W: Problem unlinking the file /var/cache/apt/srcpkgcache.bin - RemoveCaches (13: Permission denied)&#34;</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">&#34;stdout&#34;</span>: <span style="color:#e6db74">&#34;Reading package lists...\n&#34;</span>, <span style="color:#e6db74">&#34;stdout_lines&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;Reading package lists...&#34;</span><span style="color:#f92672">]}</span>

PLAY RECAP *********************************************************************************************************************************************************************************************************************************
192.168.149.131            : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>   
192.168.149.133            : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>     
</code></pre></div><p><br></br>
剛才失敗的task動作的順序原本是這樣：</p>
<p>login → apt install python3</p>
<p>只要加了become動作會變成：</p>
<p>login → sudo apt install python3</p>
<p>但是target是debian，預設沒有sudo，所以範例會是下列的樣子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:playbook.yml" data-lang=":playbook.yml">
---
- <span style="color:#66d9ef">hosts</span>: group1
<span style="display:block;width:100%;background-color:#3c3d38">  <span style="color:#66d9ef">become</span>: yes
</span><span style="display:block;width:100%;background-color:#3c3d38">  <span style="color:#66d9ef">become_method</span>: su
</span>  <span style="color:#66d9ef">tasks</span>:
    - <span style="color:#66d9ef">name</span>: install latest python3
      <span style="color:#66d9ef">apt</span>:
        <span style="color:#66d9ef">name</span>: python3
        <span style="color:#66d9ef">state</span>: present
        <span style="color:#66d9ef">update_cache</span>: yes
</code></pre></div><p><br></br>
接下來就能使用playbook的task安裝python3了，記得option加上-K，輸入become password</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml -K
BECOME password: 

PLAY <span style="color:#f92672">[</span>group1<span style="color:#f92672">]</span> ******************************************************************************************************************************************************************************************************************************

TASK <span style="color:#f92672">[</span>Gathering Facts<span style="color:#f92672">]</span> *********************************************************************************************************************************************************************************************************************
ok: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span>
ok: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>install latest python3<span style="color:#f92672">]</span> **************************************************************************************************************************************************************************************************************
ok: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span>
ok: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span>

PLAY RECAP *********************************************************************************************************************************************************************************************************************************
192.168.149.131            : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>   
192.168.149.133            : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  
</code></pre></div><p><br></br></p>
<h3 id="建立role">建立Role</h3>
<hr>
<p><br></br>
接下來就是建立role了，role裡面可以包含許多task，方便整理</p>
<pre><code>$ mkdir -p roles/common/tasks
</code></pre><p><br></br>
既然要重複使用role，想必一定要有判斷作業系統設定比較合理，常見的像是RPM-Based和DEB-Based，在安裝時就需要yum跟apt不同module，
這次練習就依照這情境，建立測試用的task，分別是main.yml、redhat.yml、debian.yml</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:roles/common/tasks/main.yml" data-lang=":roles/common/tasks/main.yml">
- <span style="color:#66d9ef">name</span>: test os
  <span style="color:#66d9ef">import_tasks</span>: redhat.yml
  <span style="color:#66d9ef">when</span>: ansible_facts[<span style="color:#e6db74">&#39;os_family&#39;</span>]|lower == <span style="color:#e6db74">&#39;redhat&#39;</span>
- <span style="color:#66d9ef">import_tasks</span>: debian.yml
  <span style="color:#66d9ef">when</span>: ansible_facts[<span style="color:#e6db74">&#39;os_family&#39;</span>]|lower == <span style="color:#e6db74">&#39;debian&#39;</span>
</code></pre></div><p><br></br></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:roles/common/tasks/redhat.yml" data-lang=":roles/common/tasks/redhat.yml">
- <span style="color:#66d9ef">shell</span>: echo <span style="color:#e6db74">&#39;I am redhat&#39;</span>
  <span style="color:#66d9ef">register</span>: shell_result
- <span style="color:#66d9ef">debug</span>:
    <span style="color:#66d9ef">var</span>: shell_result.stdout_lines
</code></pre></div><p><br></br></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:roles/common/tasks/debian.yml" data-lang=":roles/common/tasks/debian.yml">
- <span style="color:#66d9ef">shell</span>: echo <span style="color:#e6db74">&#39;I am debian&#39;</span>
  <span style="color:#66d9ef">register</span>: shell_result
- <span style="color:#66d9ef">debug</span>:
    <span style="color:#66d9ef">var</span>: shell_result.stdout_lines
</code></pre></div><p>使用shell module，用debug來收回stdout
<br></br>
目錄的樹狀圖會是這樣</p>
<pre><code>.
├── playbook.yml
└── roles
    └── common
        └── tasks
            ├── debian.yml
            ├── main.yml
            └── redhat.yml
</code></pre><p><br></br>
接著變更inventory，加上group2，內有一台centos</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#66d9ef">all</span>:
  <span style="color:#66d9ef">children</span>:
    <span style="color:#66d9ef">group1</span>:
      <span style="color:#66d9ef">hosts</span>:
        <span style="color:#66d9ef">192.168.149.131</span>:
        <span style="color:#66d9ef">192.168.149.133</span>:
      <span style="color:#66d9ef">vars</span>:
        <span style="color:#66d9ef">ansible_user</span>: qaz
        <span style="color:#66d9ef">ansible_password</span>: <span style="color:#ae81ff">123</span>
        <span style="color:#66d9ef">ansible_python_interpreter</span>: auto_legacy_silent

    <span style="color:#66d9ef">group2</span>:
      <span style="color:#66d9ef">hosts</span>:
        <span style="color:#66d9ef">192.168.149.132</span>:
      <span style="color:#66d9ef">vars</span>:
        <span style="color:#66d9ef">ansible_user</span>: root
        <span style="color:#66d9ef">ansible_password</span>: <span style="color:#ae81ff">123</span>
        <span style="color:#66d9ef">ansible_python_interpreter</span>: auto_legacy_silent
</code></pre></div><p><br></br>
playbook增加剛才的group，兩個group的role同為common</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-:playbook.yml" data-lang=":playbook.yml">
---
- <span style="color:#66d9ef">hosts</span>: group1
  <span style="color:#66d9ef">become</span>: yes
  <span style="color:#66d9ef">become_method</span>: su
  <span style="color:#66d9ef">roles</span>:
    - common

- <span style="color:#66d9ef">hosts</span>: group2
  <span style="color:#66d9ef">roles</span>:
    - common
</code></pre></div><p><br></br>
這樣輸出的畫面就是這樣，顯而易見兩者echo的是不同的string，這樣基礎練習就到此為止收工啦</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook.yml -K
BECOME password: 

PLAY <span style="color:#f92672">[</span>group1<span style="color:#f92672">]</span> ******************************************************************************************************************************************************************************************************************************

TASK <span style="color:#f92672">[</span>Gathering Facts<span style="color:#f92672">]</span> *********************************************************************************************************************************************************************************************************************
ok: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span>
ok: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>common : shell<span style="color:#f92672">]</span> **********************************************************************************************************************************************************************************************************************
skipping: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span>
skipping: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>common : debug<span style="color:#f92672">]</span> **********************************************************************************************************************************************************************************************************************
skipping: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span>
skipping: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>common : shell<span style="color:#f92672">]</span> **********************************************************************************************************************************************************************************************************************
changed: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span>
changed: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>common : debug<span style="color:#f92672">]</span> **********************************************************************************************************************************************************************************************************************
ok: <span style="color:#f92672">[</span>192.168.149.133<span style="color:#f92672">]</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;shell_result.stdout_lines&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#e6db74">&#34;I am debian&#34;</span>
    <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
ok: <span style="color:#f92672">[</span>192.168.149.131<span style="color:#f92672">]</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;shell_result.stdout_lines&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#e6db74">&#34;I am debian&#34;</span>
    <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>

PLAY <span style="color:#f92672">[</span>group2<span style="color:#f92672">]</span> ******************************************************************************************************************************************************************************************************************************

TASK <span style="color:#f92672">[</span>Gathering Facts<span style="color:#f92672">]</span> *********************************************************************************************************************************************************************************************************************
ok: <span style="color:#f92672">[</span>192.168.149.132<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>common : shell<span style="color:#f92672">]</span> **********************************************************************************************************************************************************************************************************************
changed: <span style="color:#f92672">[</span>192.168.149.132<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>common : debug<span style="color:#f92672">]</span> **********************************************************************************************************************************************************************************************************************
ok: <span style="color:#f92672">[</span>192.168.149.132<span style="color:#f92672">]</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;shell_result.stdout_lines&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#e6db74">&#34;I am redhat&#34;</span>
    <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>

TASK <span style="color:#f92672">[</span>common : shell<span style="color:#f92672">]</span> **********************************************************************************************************************************************************************************************************************
skipping: <span style="color:#f92672">[</span>192.168.149.132<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>common : debug<span style="color:#f92672">]</span> **********************************************************************************************************************************************************************************************************************
skipping: <span style="color:#f92672">[</span>192.168.149.132<span style="color:#f92672">]</span>

PLAY RECAP *********************************************************************************************************************************************************************************************************************************
192.168.149.131            : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>   
192.168.149.132            : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>   
192.168.149.133            : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>   
</code></pre></div>